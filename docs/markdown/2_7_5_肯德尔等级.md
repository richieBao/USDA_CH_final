> Created on Thu Dec 15 21:13:53 2022  @author: Richie Bao-caDesign设计(cadesign.cn)

## 2.7.5 空间动力学——空间Kendall’s Tau


### 2.7.5.1 空气质量指数数据集

#### 1）空气质量指数（Air quality index，AQI）

AQI一般通过空气质量传感器均值读数获得，通常因为车辆交通、森林火灾及任何可能增加空气污染的因素使得AQI值增加<sup>[1]</sup>。测试的污染物一般有臭氧、二氧化氮、二氧化硫等。AQI常被政府机构<sup>[2]</sup>用来向公众传达当前空气污染程度或者预测的空气污染程度<sup>[3][4]</sup>。公共健康风险伴随AQI值的增加而增加，特别影响到儿童、老人和有呼吸道或心血管问题的人，因此对AQI的变化监测，对其分布特征和成因分析，有助于平衡人类生产活动，减轻公共健康的影响程度。不同国家AQI计算方法各异，对应各自的空气质量标准，因为分析的AQI数据集符合美国环境保护局（ United States Environmental Protection Agency，EPA） 制定的标准，因此以此为例。此类AQI值被划分为6类，如下图<sup>[1]</sup>：

<table>

<tbody><tr>
<td>
<table border="2" cellspacing="0" style="width:480px; float:left;">

<tbody><tr style="vertical-align:top; background:#036;">
<td style="width:31%;"><b><span style="color:#fff; font-family:arial; font-size:1em;">Air Quality Index (AQI) Values</span></b></td>
<td style="background:#036; width:32%;"><span style="color:#fff; font-family:arial; font-size:1em;"><b>Levels of Health Concern</b></span></td>
<td style="background:#036; width:37%;"><span style="color:#fff; font-family:arial; font-size:1em;"><b>Colors</b></span>
</td></tr>
<tr style="vertical-align:top; background:#00e400;">
<td style="width:31%;">0 to 50</td>
<td style="width:32%;">Good</td>
<td style="width:37%;">Green
</td></tr>
<tr style="vertical-align:top; background:#ff0;">
<td style="width:31%;">51 to 100</td>
<td style="width:32%;">Moderate</td>
<td style="width:37%;">Yellow
</td></tr>
<tr style="vertical-align:top; background:#ff7e00;">
<td style="width:31%;">101 to 150</td>
<td style="width:32%;">Unhealthy for Sensitive Groups</td>
<td style="width:37%;">Orange
</td></tr>
<tr style="vertical-align:top; background:#f00;">
<td style="width:31%;"><span style="color:#fff;">151 to 200</span></td>
<td style="width:32%;"><span style="color:#fff;">Unhealthy</span></td>
<td style="width:37%;"><span style="color:#fff;">Red</span>
</td></tr>
<tr style="vertical-align:top; background:#8f3f97;">
<td style="width:31%;"><span style="color:#fff;">201 to 300</span></td>
<td style="width:32%;"><span style="color:#fff;">Very Unhealthy</span></td>
<td style="width:37%;"><span style="color:#fff;">Purple</span>
</td></tr>
<tr style="vertical-align:top; background:#7e0023;">
<td style="width:31%;"><span style="color:#fff;">301 to 500</span></td>
<td style="width:32%;"><span style="color:#fff;">Hazardous</span></td>
<td style="width:37%;"><span style="color:#fff;">Maroon</span>
</td></tr></tbody></table>
</td></tr></tbody></table>

AQI测量的污染物基于*Clean Air Act*<sup>①</sup>中规定的5种指示污染物：地面臭氧、颗粒物、一氧化碳、二氧化硫和二氧化氮。同时为了保护公众健康，EPA为每一种污染物制定了国家环境空气质量标准（National Ambient Air Quality Standards，NAAQS），且要求每五年审查一次国家环境空气质量标准，以反映不断变化的健康影响信息，空气质量指数定期调整以反映这些变化。

* AQI计算方法

AQI是污染物浓度的一个分段线性函数（piecewise linear function）。在AQI分段之间的边界，会出现一个AQI单位的不连续跳跃，将空气污染浓度转换为AQI，公式如下<sup>[5]</sup>：

$\displaystyle I={\frac {I_{high}-I_{low}}{C_{high}-C_{low}}}(C-C_{low})+I_{low}$

> 如果测量了多种污染物，计算出的AQI是对每种污染物应用上述公式计算出的最高值。

式中，$I$为AQI；$C$为污染物浓度；$C_{low}$为对应分段小于$C$的浓度断点；$C_{high}$为对应分段大于$C$的浓度断点；$I_{low}$为对应$C_{low}$的索引断点；$I_{high}$为对应$C_{high}$的索引断点。EPA给定的断点表如下<sup>[1][6][7][8]</sup>：


<table class="wikitable" style="text–align:left;">

<tbody><tr>
<td><b><a href="/wiki/Ozone" title="Ozone">O<sub>3</sub></a> (ppb)</b></td>
<td><b><a href="/wiki/Ozone" title="Ozone">O<sub>3</sub></a> (ppb)</b></td>
<td><b><a href="/wiki/Particulates" title="Particulates">PM<sub>2.5</sub></a> (μg/m<sup>3</sup>)</b></td>
<td><b><a href="/wiki/Particulates" title="Particulates">PM<sub>10</sub></a> (μg/m<sup>3</sup>)</b></td>
<td><b><a href="/wiki/Carbon_monoxide" title="Carbon monoxide">CO</a> (ppm)</b></td>
<td><b><a href="/wiki/Sulfur_dioxide" title="Sulfur dioxide">SO<sub>2</sub></a> (ppb)</b></td>
<td><b><a href="/wiki/Nitrogen_dioxide" title="Nitrogen dioxide">NO<sub>2</sub></a> (ppb)</b></td>
<td><b>AQI</b></td>
<td><b>AQI</b>
</td></tr>
<tr>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>C<sub>low</sub></i> – <i>C<sub>high</sub> (avg)</i></td>
<td><i>I<sub>low</sub></i> – <i>I<sub>high</sub></i></td>
<td><b>Category</b>
</td></tr>
<tr>
<td>0–54 (8-hr)</td>
<td>—</td>
<td>0.0–12.0 (24-hr)</td>
<td>0–54 (24-hr)</td>
<td>0.0–4.4 (8-hr)</td>
<td>0–35 (1-hr)</td>
<td>0–53 (1-hr)</td>
<td>0–50</td>
<td style="background:#00e400;">Good
</td></tr>
<tr>
<td>55–70 (8-hr)</td>
<td>—</td>
<td>12.1–35.4 (24-hr)</td>
<td>55–154 (24-hr)</td>
<td>4.5–9.4 (8-hr)</td>
<td>36–75 (1-hr)</td>
<td>54–100 (1-hr)</td>
<td>51–100</td>
<td style="background:#ff0;">Moderate
</td></tr>
<tr>
<td>71–85 (8-hr)</td>
<td>125–164 (1-hr)</td>
<td>35.5–55.4 (24-hr)</td>
<td>155–254 (24-hr)</td>
<td>9.5–12.4 (8-hr)</td>
<td>76–185 (1-hr)</td>
<td>101–360 (1-hr)</td>
<td>101–150</td>
<td style="background:#ff7e00;">Unhealthy for Sensitive Groups
</td></tr>
<tr>
<td>86–105 (8-hr)</td>
<td>165–204 (1-hr)</td>
<td>55.5–150.4 (24-hr)</td>
<td>255–354 (24-hr)</td>
<td>12.5–15.4 (8-hr)</td>
<td>186–304 (1-hr)</td>
<td>361–649 (1-hr)</td>
<td>151–200</td>
<td style="background:#f00; color:#fff;">Unhealthy
</td></tr>
<tr>
<td>106–200 (8-hr)</td>
<td>205–404 (1-hr)</td>
<td>150.5–250.4 (24-hr)</td>
<td>355–424 (24-hr)</td>
<td>15.5–30.4 (8-hr)</td>
<td>305–604 (24-hr)</td>
<td>650–1249 (1-hr)</td>
<td>201–300</td>
<td style="background:#8f3f97; color:#fff;">Very Unhealthy
</td></tr>
<tr>
<td>—</td>
<td>405–504 (1-hr)</td>
<td>250.5–350.4 (24-hr)</td>
<td>425–504 (24-hr)</td>
<td>30.5–40.4 (8-hr)</td>
<td>605–804 (24-hr)</td>
<td>1250–1649 (1-hr)</td>
<td>301–400</td>
<td style="background:#7e0023; color:#fff;" rowspan="2">Hazardous
</td></tr>
<tr>
<td>—</td>
<td>505–604 (1-hr)</td>
<td>350.5–500.4 (24-hr)</td>
<td>505–604 (24-hr)</td>
<td>40.5–50.4 (8-hr)</td>
<td>805–1004 (24-hr)</td>
<td>1650–2049 (1-hr)</td>
<td>401–500
</td></tr></tbody></table>


假设传感器监测到PM<sub>2.5</sub>的24小时测量均值为26.4微克/立方米，根据上述公式并查表得出：$\displaystyle {\frac {100-51}{35.4-12.1}}(26.4-12.1)+51=81.073$，根据表查到81.073对应到的AQI分类为“Moderate”。

#### 2）AQI数据集

从[Kaggle](https://www.kaggle.com/)<sup>②</sup>中搜索AQI相关数据集，选择[Air Quality Index Dataset](https://www.kaggle.com/datasets/pratikshapandapkp/air-quality-index-dataset)<sup>④</sup>的AQI数据集，并参考该作者数据处理可视化的方法进行数据预处理。该数据列出了世界大部分国家从2022年7月21日到2022年9月22日约63天，以日为周期的AQI数值。


> Kaggle是Google的子公司，是一个数据科学家和机器学习从业者的在线社区。Kaggle允许用户寻找和发布数据集，在基于网络的数据科学环境中探索和建立模型，与其他数据科学家和机器学习工程师合作，并通过参加比赛的形式解决数据科学挑战问题。Kaggle于2010年首次推出，提供机器学习比赛，现在还提供一个公共数据平台，及人工智能教育。<sup>③</sup>

参数管理使用`AttrDict()`方法（具体查看“Cityscapes数据集——参数管理”一节）。其中数据读写位置路径置于`data`子属性下。


```python
from util_misc import AttrDict
__C=AttrDict() 
args=__C

__C.data=AttrDict()
__C.data.AQI='./data/Air_Quality_Index_Data.csv' # AQI数据集文件路径
__C.data.aqi_world='./data/AQI_world.geojson' # 将AQI数据集合并世界国家边界地图后，文件存储路径
```

通过`pandas`库提供的`read_csv`方法读取CSV格式数据为DataFrame格式，并将时间字符列通过`pd.to_datetime`方法转换为`datetime64[ns]`类型时间格式且增加新列为`ts`。为了便于查看DataFrame格式数据的主要信息，定义`df_info_print()`函数，可以统一打印数据行列数、列唯一值数据、基础统计量、各列空值数据量和数值类型等。


```python
import pandas as pd

df_info_print=lambda df:print(f"# df shape: {df.shape};\n# nunique:\n {df.nunique()};\n# describe: \n{df.describe()}\n# isna sum:\n {df.isna().sum()}\n#type:\n {df.dtypes}")
        
aqi_df=pd.read_csv(args.data.AQI)
aqi_df['ts']=pd.to_datetime(aqi_df.Date,format='%d-%m-%Y')
df_info_print(aqi_df)
aqi_df.head()
```

    # df shape: (9994, 5);
    # nunique:
     Date          64
    Country      142
    Status         6
    AQI Value    256
    ts            64
    dtype: int64;
    # describe: 
             AQI Value
    count  9994.000000
    mean     60.795477
    std      45.763604
    min       1.000000
    25%      29.000000
    50%      52.000000
    75%      82.000000
    max     868.000000
    # isna sum:
     Date         0
    Country      0
    Status       0
    AQI Value    0
    ts           0
    dtype: int64
    #type:
     Date                 object
    Country              object
    Status               object
    AQI Value             int64
    ts           datetime64[ns]
    dtype: object
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Country</th>
      <th>Status</th>
      <th>AQI Value</th>
      <th>ts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21-07-2022</td>
      <td>Albania</td>
      <td>Good</td>
      <td>14</td>
      <td>2022-07-21</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21-07-2022</td>
      <td>Algeria</td>
      <td>Moderate</td>
      <td>65</td>
      <td>2022-07-21</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21-07-2022</td>
      <td>Andorra</td>
      <td>Moderate</td>
      <td>55</td>
      <td>2022-07-21</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21-07-2022</td>
      <td>Angola</td>
      <td>Unhealthy for Sensitive Groups</td>
      <td>113</td>
      <td>2022-07-21</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21-07-2022</td>
      <td>Argentina</td>
      <td>Moderate</td>
      <td>63</td>
      <td>2022-07-21</td>
    </tr>
  </tbody>
</table>
</div>



需要对国家名进行修正，一方面是与下文中世界国家边界数据的国家名未对应部分的修正；另一方面是分类不正确的区域命名的修正。


```python
aqi_df["Country"]=aqi_df["Country"].replace({'United Kingdom of Great Britain and Northern Ireland':"United Kingdom",
                                             'Hong Kong':'Hong Kong,China',
                                             'Taiwan': 'Taiwan, China'})
```

[Plotly](https://plotly.com/python/#controls)<sup>⑤</sup>库提供了交互动态观察时间序列数据的图表方法，使用`px.bar`方法，指定值参数为AQI数值列，按照国家地区，给定动画帧参数`animation_frame`为时间列，打印条形图。可以通过拖动显示的滑条或者运行停止按钮动态观察不同时间AQI值的变化情况。


```python
import plotly.express as px
import matplotlib.pyplot as plt

plt.figure(figsize=(25,20))
px.bar(aqi_df , x="AQI Value", y="Country", color="Status", animation_frame="Date", width=1400,height=1000)
```

<img src="./imgs/2_7_5/output_9_0.png" height='auto' width='auto' title="caDesign">


条形图并不能显示AQI数值变化的空间分布情况，可以使用`px.choropleth`打印地图观察实现。


```python
fig=px.choropleth(aqi_df,locations="Country", 
                  locationmode='country names', color="AQI Value", 
                  animation_frame="Date",range_color=[25,450], width=1400, height=700)
fig.show()
```

<img src="./imgs/2_7_5/output_11_0.png" height='auto' width='auto' title="caDesign">


同样打印AQI分类类别，以Good（良好）、Moderate（中度）、Unhealthy for Sensitive Groups（对敏感群体不健康）、Unhealthy（不健康）、Very Unhealthy（非常不健康）和Hazardous（危险） 6类指示空间质量（对公众健康影响的空气污染程度）。


```python
fig=px.choropleth(aqi_df,locations="Country", 
                  locationmode='country names', color="Status", 
                  animation_frame="Date",range_color=[25,450], width=1400, height=700)
fig.show()
```

<img src="./imgs/2_7_5/output_13_0.png" height='auto' width='auto' title="caDesign">



通过饼状图统计63天AQI测量值各国所占比例，从结果可以看到从7月末到9月末，空气污染程度较高的前10个国家为：Qatar（卡塔尔）、Iraq（伊拉克）、India（印度）、Iran（伊朗）、Ethiopia（埃塞俄比亚）、China（中国）、Kuwait（科威特）、Bangladesh（孟加拉国）、United Arab Emirates（阿拉伯联合酋长国）和Bahrain（巴林）等。


```python
fig = px.pie(aqi_df, names="Country" ,
             values="AQI Value", title="AQI value of all countries", 
             hover_data=["Status"],width=1400, height=1400)
fig.update_traces(textposition='inside', textinfo='percent+label')
```

<img src="./imgs/2_7_5/output_15_0.png" height='auto' width='auto' title="caDesign">


* 世界地图国家边界

`GeoPandas`库提供了世界地图国家边界数据，可以直接读取。同样需要对不正确的国家名称进行修正。


```python
import geopandas as gpd
world=gpd.read_file(gpd.datasets.get_path('naturalearth_lowres'))
world["name"]=world["name"].replace({ 'Hong Kong':'Hong Kong,China',
                                      'Taiwan': 'Taiwan, China'})

world.plot();
```

<img src="./imgs/2_7_5/output_17_0.png" height='auto' width='auto' title="caDesign">
    

首先需要明确AQI数据集中国家类别`Country`列，与世界地图国家边界（国界）地理数据中国家类别`name`列中的国家名是否一致。定义`str_listAINlistB()`函数进行检查，打印AQI数据中出现而国界中未找到对应的国家或地区名有27个，这27个数据行将不被用于后续分析。


```python
def str_listAINlistB(listA,listB,lower=False):
    '''
    核实一个字符串列表元素（listA）是否在另一个字符串列表（listB）中，或被字符所包含，例如`abc`在'abc def'中也计入。

    Parameters
    ----------
    listA : list(string)
        字符传列表A.
    listB : list(string)
        字符传列表B.
    lower : bool, optional
        是否字符全部转小写，即区分大小写. The default is False.

    Returns
    -------
    elements_in : dict(string:int)
        如果为0则不包含，否则包含.

    '''    
    if lower:
        listA=[i.lower() for i in listA]
        listB=[i.lower() for i in  listB]
    elements_in={}
    for e in listA:      
        is_in=e in listB 
        if is_in:
            elements_in[e]=1
        else:
            is_in_sum=sum([e in i for i in listB])
            if is_in_sum>0:
                elements_in[e]=1
            else:
                elements_in[e]=0  
    return elements_in
                
c_n_aqi=aqi_df.Country.unique()
c_n_world=world.name.unique()                
c_n_in=str_listAINlistB(c_n_aqi,c_n_world,lower=True)          
c_n_notin={k:v  for k,v in c_n_in.items() if v==0}
print(c_n_notin)
```

    {'andorra': 0, 'bahrain': 0, 'bermuda': 0, 'bosnia and herzegovina': 0, 'cape verde': 0, 'cayman islands': 0, 'central african republic': 0, 'czech republic': 0, 'dominican republic': 0, 'french guiana': 0, 'gibraltar': 0, 'grenada': 0, 'guadeloupe': 0, 'guam': 0, 'hong kong,china': 0, 'ivory coast': 0, 'jersey': 0, 'liechtenstein': 0, 'macao': 0, 'malta': 0, 'martinique': 0, 'monaco': 0, 'palestinian territory': 0, 'reunion': 0, 'san marino': 0, 'singapore': 0, 'vatican': 0}
    

AQI数据集为非地理空间数据，需要按照国名合入国界地理信息数据，通过`pd.merge`方法，指定合并关键列进行合并。打印合并后的GeoDataFrame格式数据，观察数据缺失情况，其中蓝灰偏白区域没有数据。


```python
aqi_world_df=pd.merge(aqi_df,world,how='left',left_on=['Country'],right_on=['name'])
aqi_world_gdf=gpd.GeoDataFrame(aqi_world_df,geometry='geometry',crs=world.crs)
aqi_world_gdf.dropna(subset=['geometry'],inplace=True)
aqi_world_gdf
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Country</th>
      <th>Status</th>
      <th>AQI Value</th>
      <th>ts</th>
      <th>pop_est</th>
      <th>continent</th>
      <th>name</th>
      <th>iso_a3</th>
      <th>gdp_md_est</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21-07-2022</td>
      <td>Albania</td>
      <td>Good</td>
      <td>14</td>
      <td>2022-07-21</td>
      <td>2854191.0</td>
      <td>Europe</td>
      <td>Albania</td>
      <td>ALB</td>
      <td>15279.0</td>
      <td>POLYGON ((21.02004 40.84273, 20.99999 40.58000...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21-07-2022</td>
      <td>Algeria</td>
      <td>Moderate</td>
      <td>65</td>
      <td>2022-07-21</td>
      <td>43053054.0</td>
      <td>Africa</td>
      <td>Algeria</td>
      <td>DZA</td>
      <td>171091.0</td>
      <td>POLYGON ((-8.68440 27.39574, -8.66512 27.58948...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21-07-2022</td>
      <td>Angola</td>
      <td>Unhealthy for Sensitive Groups</td>
      <td>113</td>
      <td>2022-07-21</td>
      <td>31825295.0</td>
      <td>Africa</td>
      <td>Angola</td>
      <td>AGO</td>
      <td>88815.0</td>
      <td>MULTIPOLYGON (((12.99552 -4.78110, 12.63161 -4...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21-07-2022</td>
      <td>Argentina</td>
      <td>Moderate</td>
      <td>63</td>
      <td>2022-07-21</td>
      <td>44938712.0</td>
      <td>South America</td>
      <td>Argentina</td>
      <td>ARG</td>
      <td>445445.0</td>
      <td>MULTIPOLYGON (((-68.63401 -52.63637, -68.25000...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21-07-2022</td>
      <td>Armenia</td>
      <td>Moderate</td>
      <td>76</td>
      <td>2022-07-21</td>
      <td>2957731.0</td>
      <td>Asia</td>
      <td>Armenia</td>
      <td>ARM</td>
      <td>13672.0</td>
      <td>POLYGON ((46.50572 38.77061, 46.14362 38.74120...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9988</th>
      <td>22-09-2022</td>
      <td>United States of America</td>
      <td>Unhealthy for Sensitive Groups</td>
      <td>109</td>
      <td>2022-09-22</td>
      <td>328239523.0</td>
      <td>North America</td>
      <td>United States of America</td>
      <td>USA</td>
      <td>21433226.0</td>
      <td>MULTIPOLYGON (((-122.84000 49.00000, -120.0000...</td>
    </tr>
    <tr>
      <th>9989</th>
      <td>22-09-2022</td>
      <td>Uzbekistan</td>
      <td>Moderate</td>
      <td>66</td>
      <td>2022-09-22</td>
      <td>33580650.0</td>
      <td>Asia</td>
      <td>Uzbekistan</td>
      <td>UZB</td>
      <td>57921.0</td>
      <td>POLYGON ((55.96819 41.30864, 55.92892 44.99586...</td>
    </tr>
    <tr>
      <th>9991</th>
      <td>22-09-2022</td>
      <td>Venezuela</td>
      <td>Good</td>
      <td>20</td>
      <td>2022-09-22</td>
      <td>28515829.0</td>
      <td>South America</td>
      <td>Venezuela</td>
      <td>VEN</td>
      <td>482359.0</td>
      <td>POLYGON ((-60.73357 5.20028, -60.60118 4.91810...</td>
    </tr>
    <tr>
      <th>9992</th>
      <td>22-09-2022</td>
      <td>Vietnam</td>
      <td>Moderate</td>
      <td>76</td>
      <td>2022-09-22</td>
      <td>96462106.0</td>
      <td>Asia</td>
      <td>Vietnam</td>
      <td>VNM</td>
      <td>261921.0</td>
      <td>POLYGON ((104.33433 10.48654, 105.19991 10.889...</td>
    </tr>
    <tr>
      <th>9993</th>
      <td>22-09-2022</td>
      <td>Zambia</td>
      <td>Unhealthy</td>
      <td>161</td>
      <td>2022-09-22</td>
      <td>17861030.0</td>
      <td>Africa</td>
      <td>Zambia</td>
      <td>ZMB</td>
      <td>23309.0</td>
      <td>POLYGON ((30.74001 -8.34001, 31.15775 -8.59458...</td>
    </tr>
  </tbody>
</table>
<p>8012 rows × 11 columns</p>
</div>




```python
fig=px.choropleth(aqi_world_gdf,locations="Country", 
                  locationmode='country names', color="AQI Value", 
                  animation_frame="Date",range_color=[25,450], width=1400, height=700)
fig.show()
```

<img src="./imgs/2_7_5/output_22_0.png" height='auto' width='auto' title="caDesign">



将预处理后的数据存入本地硬盘，方便后续调用。


```python
aqi_world_gdf.to_file(args.data.aqi_world,driver='GeoJSON')
```

### 2.7.5.2 基于等级方式的空间动力学

#### 1）经典肯德尔等级相关系数（Kendall’s Tau）

Kendall’s Tau是一种非参数测量，用于衡量排名（等级）数据列之间的关系。Tau相关系数返回一个-1~1的值，其中0表示排名列间没有关系，1表示有完美的正相关关系，值越趋近于1关联性越强，反之趋近于-1则为负相关。以[Kendall’s Tau (Kendall Rank Correlation Coefficient)](https://www.statisticshowto.com/kendalls-tau/)<sup>⑥</sup>提供的案例数据为例，通过建立简单的数据样本，根据公式书写代码逐步计算。其公式为：$Kendall’s Tau = \frac{C – D}{C + D} $，式中$C$为协和对数量（concordant pairs）；$D$为不协和对数量（disconcordant pairs）。区分协和对和不协和对的方式可以通过固定排序`rank_1`列，比较`rank_2`列每1行数据与其后数据大小的比较获得，如果大于为协和对；小于为不协和对；等于为无效对。如果不对`rank_1`先排序，则可以通过对$\frac{ Y_{j}-  Y_{i}}{X_{j}-  X_{i} } $值与0比较获得，式中，$X_{j}$和$Y_{i}$为两个等级数列值，如果大于0为协和对；小于0为不协和对；等于0为无效对。


```python
import pandas as pd

rank_dict=dict(name=list(map(lambda x:chr(x).upper(),range(97,97+12))),
               rank_1=list(range(1,13)),
               rank_2=[1,2,4,3,6,5,8,7,10,9,12,11])

rank_df=pd.DataFrame(rank_dict)

rank_2=rank_df.rank_2.to_list()
concordant=[sum(map(lambda x:x>rank_2[i],rank_2[i:])) for i in range(len(rank_2))]
discordant=[sum(map(lambda x:x<rank_2[i],rank_2[i:])) for i in range(len(rank_2))]
rank_df['concordant']=concordant
rank_df['discordant']=discordant
rank_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>rank_1</th>
      <th>rank_2</th>
      <th>concordant</th>
      <th>discordant</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>1</td>
      <td>1</td>
      <td>11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>B</td>
      <td>2</td>
      <td>2</td>
      <td>10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C</td>
      <td>3</td>
      <td>4</td>
      <td>8</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>D</td>
      <td>4</td>
      <td>3</td>
      <td>8</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>E</td>
      <td>5</td>
      <td>6</td>
      <td>6</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>F</td>
      <td>6</td>
      <td>5</td>
      <td>6</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>G</td>
      <td>7</td>
      <td>8</td>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>H</td>
      <td>8</td>
      <td>7</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>I</td>
      <td>9</td>
      <td>10</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>J</td>
      <td>10</td>
      <td>9</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>K</td>
      <td>11</td>
      <td>12</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>L</td>
      <td>12</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



通过上述对各行协和对和不协和对数量的统计，带入Kendall’s Tau公式计算结果值为0.848，表明`rank_1`和`ranki_2`列具有很强的正相关性。


```python
c_sum=sum(concordant)
d_sum=sum(discordant)
Kendalls_Tau=(c_sum-d_sum)/(c_sum+d_sum)
print(f"concordant: {concordant}, c_sum={c_sum};\ndiscordant: {discordant}, d_sum={d_sum};\nKendall’s Tau={round(Kendalls_Tau,3)}")
```

    concordant: [11, 10, 8, 8, 6, 6, 4, 4, 2, 2, 0, 0], c_sum=61;
    discordant: [0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0], d_sum=5;
    Kendall’s Tau=0.848
    

`giddy`库提供了`giddy.rank.Tau`方法直接计算Kendall’s Tau，其公式<sup>⑦</sup>为：$\tau = \frac{c-d}{(n(n-1))/2}$，式中$c$即为协和对数量，$d$为不协和对数量，$n$为等级列行数（或解释为空间单元数），$\tau$值位于[-1,1]区间。通过`giddy`库提供的方法计算结果为0.848，与上文计算结果同。


```python
import giddy

tau=giddy.rank.Tau(rank_df["rank_1"],rank_df["rank_2"])
print(tau.concordant,tau.discordant,tau.tau.round(3),tau.tau_p)
```

    61.0 5.0 0.848 0.00012300294510098186
    

#### 2）空间Kendall’s Tau

空间Kendall’s Tau是将所有配对按指定的空间邻域分组，检查两组之间的等级相关性<sup>[9]</sup>，其公式为：$\tau_w = \frac{\iota'(W\circ S)\iota}{\iota'W \iota}$，式中，$W$为空间权重，$S$为协和矩阵（concordance matrix），$\iota$为$(n,1)$的统一向量。无效假设为等级交换的空间随机性。因为单独输入权重参数`w`，且使用`libpysa（PySAL）`库提供的`block_weights`空间权重方法，因此$\tau_w$的推断计算将不受空间单元的数据行排列影响。`block_weights`方法是根据定义的空间单元所属空间组（例如县界所属省界，国界所属大洲等）进行计算，例如`libpysa`库提供的案例<sup>⑧</sup>。

* `block_weights`空间权重

定义列表`regimes`为分组信息，包括类名为1，2，3等3个分组，空间权重值对应到该单元的邻里单元。


```python
from libpysal.weights import block_weights
import numpy as np

regimes=np.ones(25)
regimes[range(10,20)]=2
regimes[range(21,25)]=3
print(f"空间分组（regime）:{regimes}")

w=block_weights(regimes)
print(f"单元0的空间权重为：{w.weights[0]};\n单元0的邻里单元：{w.neighbors[0]}")
print('所有空间单元的邻里单元：')
w.neighbors
```

    空间分组（regime）:[1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 1. 3. 3. 3.
     3.]
    单元0的空间权重为：[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
    单元0的邻里单元：[1, 2, 3, 4, 5, 6, 7, 8, 9, 20]
    所有空间单元的邻里单元：
    




    {0: [1, 2, 3, 4, 5, 6, 7, 8, 9, 20],
     1: [0, 2, 3, 4, 5, 6, 7, 8, 9, 20],
     2: [0, 1, 3, 4, 5, 6, 7, 8, 9, 20],
     3: [0, 1, 2, 4, 5, 6, 7, 8, 9, 20],
     4: [0, 1, 2, 3, 5, 6, 7, 8, 9, 20],
     5: [0, 1, 2, 3, 4, 6, 7, 8, 9, 20],
     6: [0, 1, 2, 3, 4, 5, 7, 8, 9, 20],
     7: [0, 1, 2, 3, 4, 5, 6, 8, 9, 20],
     8: [0, 1, 2, 3, 4, 5, 6, 7, 9, 20],
     9: [0, 1, 2, 3, 4, 5, 6, 7, 8, 20],
     20: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
     10: [11, 12, 13, 14, 15, 16, 17, 18, 19],
     11: [10, 12, 13, 14, 15, 16, 17, 18, 19],
     12: [10, 11, 13, 14, 15, 16, 17, 18, 19],
     13: [10, 11, 12, 14, 15, 16, 17, 18, 19],
     14: [10, 11, 12, 13, 15, 16, 17, 18, 19],
     15: [10, 11, 12, 13, 14, 16, 17, 18, 19],
     16: [10, 11, 12, 13, 14, 15, 17, 18, 19],
     17: [10, 11, 12, 13, 14, 15, 16, 18, 19],
     18: [10, 11, 12, 13, 14, 15, 16, 17, 19],
     19: [10, 11, 12, 13, 14, 15, 16, 17, 18],
     21: [22, 23, 24],
     22: [21, 23, 24],
     23: [21, 22, 24],
     24: [21, 22, 23]}



预处理的数据按照时间列组织每一样本的信息，为方便空间Kendall’s Tau计算，将数据形式转换为国家名（空间单元）`Country`和所属大洲（单元分组）`continent`列为行索引，以测量时间`ts`为列组织数据，核心使用的方法是`pandas`提供的`pivot_table`方法。


```python
import geopandas as gpd
aqi_world_gdf=gpd.read_file(args.data.aqi_world)
aqi_world_gdf
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Country</th>
      <th>Status</th>
      <th>AQI Value</th>
      <th>ts</th>
      <th>pop_est</th>
      <th>continent</th>
      <th>name</th>
      <th>iso_a3</th>
      <th>gdp_md_est</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21-07-2022</td>
      <td>Albania</td>
      <td>Good</td>
      <td>14</td>
      <td>2022-07-21</td>
      <td>2854191.0</td>
      <td>Europe</td>
      <td>Albania</td>
      <td>ALB</td>
      <td>15279.0</td>
      <td>POLYGON ((21.02004 40.84273, 20.99999 40.58000...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21-07-2022</td>
      <td>Algeria</td>
      <td>Moderate</td>
      <td>65</td>
      <td>2022-07-21</td>
      <td>43053054.0</td>
      <td>Africa</td>
      <td>Algeria</td>
      <td>DZA</td>
      <td>171091.0</td>
      <td>POLYGON ((-8.68440 27.39574, -8.66512 27.58948...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21-07-2022</td>
      <td>Angola</td>
      <td>Unhealthy for Sensitive Groups</td>
      <td>113</td>
      <td>2022-07-21</td>
      <td>31825295.0</td>
      <td>Africa</td>
      <td>Angola</td>
      <td>AGO</td>
      <td>88815.0</td>
      <td>MULTIPOLYGON (((12.99552 -4.78110, 12.63161 -4...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21-07-2022</td>
      <td>Argentina</td>
      <td>Moderate</td>
      <td>63</td>
      <td>2022-07-21</td>
      <td>44938712.0</td>
      <td>South America</td>
      <td>Argentina</td>
      <td>ARG</td>
      <td>445445.0</td>
      <td>MULTIPOLYGON (((-68.63401 -52.63637, -68.25000...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21-07-2022</td>
      <td>Armenia</td>
      <td>Moderate</td>
      <td>76</td>
      <td>2022-07-21</td>
      <td>2957731.0</td>
      <td>Asia</td>
      <td>Armenia</td>
      <td>ARM</td>
      <td>13672.0</td>
      <td>POLYGON ((46.50572 38.77061, 46.14362 38.74120...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8007</th>
      <td>22-09-2022</td>
      <td>United States of America</td>
      <td>Unhealthy for Sensitive Groups</td>
      <td>109</td>
      <td>2022-09-22</td>
      <td>328239523.0</td>
      <td>North America</td>
      <td>United States of America</td>
      <td>USA</td>
      <td>21433226.0</td>
      <td>MULTIPOLYGON (((-122.84000 49.00000, -120.0000...</td>
    </tr>
    <tr>
      <th>8008</th>
      <td>22-09-2022</td>
      <td>Uzbekistan</td>
      <td>Moderate</td>
      <td>66</td>
      <td>2022-09-22</td>
      <td>33580650.0</td>
      <td>Asia</td>
      <td>Uzbekistan</td>
      <td>UZB</td>
      <td>57921.0</td>
      <td>POLYGON ((55.96819 41.30864, 55.92892 44.99586...</td>
    </tr>
    <tr>
      <th>8009</th>
      <td>22-09-2022</td>
      <td>Venezuela</td>
      <td>Good</td>
      <td>20</td>
      <td>2022-09-22</td>
      <td>28515829.0</td>
      <td>South America</td>
      <td>Venezuela</td>
      <td>VEN</td>
      <td>482359.0</td>
      <td>POLYGON ((-60.73357 5.20028, -60.60118 4.91810...</td>
    </tr>
    <tr>
      <th>8010</th>
      <td>22-09-2022</td>
      <td>Vietnam</td>
      <td>Moderate</td>
      <td>76</td>
      <td>2022-09-22</td>
      <td>96462106.0</td>
      <td>Asia</td>
      <td>Vietnam</td>
      <td>VNM</td>
      <td>261921.0</td>
      <td>POLYGON ((104.33433 10.48654, 105.19991 10.889...</td>
    </tr>
    <tr>
      <th>8011</th>
      <td>22-09-2022</td>
      <td>Zambia</td>
      <td>Unhealthy</td>
      <td>161</td>
      <td>2022-09-22</td>
      <td>17861030.0</td>
      <td>Africa</td>
      <td>Zambia</td>
      <td>ZMB</td>
      <td>23309.0</td>
      <td>POLYGON ((30.74001 -8.34001, 31.15775 -8.59458...</td>
    </tr>
  </tbody>
</table>
<p>8012 rows × 11 columns</p>
</div>




```python
import numpy as np
aqi_world_gdf_pivot=aqi_world_gdf[['Country','AQI Value','continent','ts']].pivot_table(index='ts',columns=['Country','continent'],aggfunc='mean', fill_value=np.nan).T
aqi_world_gdf_pivot
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>ts</th>
      <th>2022-07-21</th>
      <th>2022-07-22</th>
      <th>2022-07-23</th>
      <th>2022-07-24</th>
      <th>2022-07-25</th>
      <th>2022-07-26</th>
      <th>2022-07-27</th>
      <th>2022-07-28</th>
      <th>2022-07-29</th>
      <th>2022-07-30</th>
      <th>...</th>
      <th>2022-09-13</th>
      <th>2022-09-14</th>
      <th>2022-09-15</th>
      <th>2022-09-16</th>
      <th>2022-09-17</th>
      <th>2022-09-18</th>
      <th>2022-09-19</th>
      <th>2022-09-20</th>
      <th>2022-09-21</th>
      <th>2022-09-22</th>
    </tr>
    <tr>
      <th></th>
      <th>Country</th>
      <th>continent</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="11" valign="top">AQI Value</th>
      <th>Albania</th>
      <th>Europe</th>
      <td>15.5</td>
      <td>16.666667</td>
      <td>17.5</td>
      <td>18.0</td>
      <td>55.0</td>
      <td>43.0</td>
      <td>41.0</td>
      <td>61.0</td>
      <td>22.0</td>
      <td>111.0</td>
      <td>...</td>
      <td>7.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>28.0</td>
      <td>11.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>9.5</td>
    </tr>
    <tr>
      <th>Algeria</th>
      <th>Africa</th>
      <td>65.0</td>
      <td>65.000000</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>...</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
    </tr>
    <tr>
      <th>Angola</th>
      <th>Africa</th>
      <td>132.5</td>
      <td>123.333333</td>
      <td>107.0</td>
      <td>107.0</td>
      <td>117.0</td>
      <td>102.5</td>
      <td>123.0</td>
      <td>152.0</td>
      <td>117.0</td>
      <td>142.0</td>
      <td>...</td>
      <td>70.0</td>
      <td>77.0</td>
      <td>115.0</td>
      <td>117.0</td>
      <td>98.0</td>
      <td>82.0</td>
      <td>91.0</td>
      <td>87.0</td>
      <td>91.0</td>
      <td>87.5</td>
    </tr>
    <tr>
      <th>Argentina</th>
      <th>South America</th>
      <td>62.0</td>
      <td>57.333333</td>
      <td>55.5</td>
      <td>42.0</td>
      <td>74.0</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>23.0</td>
      <td>31.0</td>
      <td>32.0</td>
      <td>...</td>
      <td>47.0</td>
      <td>39.0</td>
      <td>23.0</td>
      <td>33.0</td>
      <td>18.0</td>
      <td>29.0</td>
      <td>21.0</td>
      <td>28.0</td>
      <td>61.0</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>Armenia</th>
      <th>Asia</th>
      <td>77.0</td>
      <td>52.666667</td>
      <td>41.5</td>
      <td>43.0</td>
      <td>78.0</td>
      <td>61.0</td>
      <td>58.0</td>
      <td>63.0</td>
      <td>41.0</td>
      <td>54.0</td>
      <td>...</td>
      <td>76.0</td>
      <td>69.0</td>
      <td>90.0</td>
      <td>62.0</td>
      <td>45.0</td>
      <td>52.0</td>
      <td>67.0</td>
      <td>64.0</td>
      <td>65.0</td>
      <td>59.0</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>United States of America</th>
      <th>North America</th>
      <td>111.5</td>
      <td>89.666667</td>
      <td>86.5</td>
      <td>85.0</td>
      <td>84.0</td>
      <td>78.5</td>
      <td>90.0</td>
      <td>80.0</td>
      <td>79.0</td>
      <td>70.0</td>
      <td>...</td>
      <td>162.0</td>
      <td>151.0</td>
      <td>105.0</td>
      <td>364.0</td>
      <td>122.0</td>
      <td>92.0</td>
      <td>92.0</td>
      <td>98.0</td>
      <td>110.0</td>
      <td>104.5</td>
    </tr>
    <tr>
      <th>Uzbekistan</th>
      <th>Asia</th>
      <td>59.0</td>
      <td>90.000000</td>
      <td>77.0</td>
      <td>73.0</td>
      <td>57.0</td>
      <td>56.5</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>26.0</td>
      <td>...</td>
      <td>57.0</td>
      <td>89.0</td>
      <td>65.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>40.0</td>
      <td>78.0</td>
      <td>95.0</td>
      <td>54.5</td>
    </tr>
    <tr>
      <th>Venezuela</th>
      <th>South America</th>
      <td>2.5</td>
      <td>13.000000</td>
      <td>20.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>16.0</td>
      <td>31.0</td>
      <td>21.0</td>
      <td>2.0</td>
      <td>13.0</td>
      <td>...</td>
      <td>15.0</td>
      <td>3.0</td>
      <td>62.0</td>
      <td>27.0</td>
      <td>7.0</td>
      <td>10.0</td>
      <td>13.0</td>
      <td>8.0</td>
      <td>40.0</td>
      <td>18.5</td>
    </tr>
    <tr>
      <th>Vietnam</th>
      <th>Asia</th>
      <td>42.0</td>
      <td>85.333333</td>
      <td>103.0</td>
      <td>92.0</td>
      <td>84.0</td>
      <td>74.0</td>
      <td>107.0</td>
      <td>118.0</td>
      <td>83.0</td>
      <td>75.0</td>
      <td>...</td>
      <td>143.0</td>
      <td>138.0</td>
      <td>109.0</td>
      <td>93.0</td>
      <td>102.0</td>
      <td>102.0</td>
      <td>97.0</td>
      <td>116.0</td>
      <td>110.0</td>
      <td>70.5</td>
    </tr>
    <tr>
      <th>Zambia</th>
      <th>Africa</th>
      <td>46.5</td>
      <td>67.333333</td>
      <td>80.0</td>
      <td>152.0</td>
      <td>89.0</td>
      <td>64.5</td>
      <td>89.0</td>
      <td>91.0</td>
      <td>105.0</td>
      <td>80.0</td>
      <td>...</td>
      <td>176.0</td>
      <td>118.0</td>
      <td>116.0</td>
      <td>99.0</td>
      <td>107.0</td>
      <td>117.0</td>
      <td>184.0</td>
      <td>155.0</td>
      <td>151.0</td>
      <td>147.5</td>
    </tr>
  </tbody>
</table>
<p>114 rows × 64 columns</p>
</div>



查看以测量时间为列的列名，包括有哪些测量时间。


```python
aqi_world_gdf_pivot.columns
```




    DatetimeIndex(['2022-07-21', '2022-07-22', '2022-07-23', '2022-07-24',
                   '2022-07-25', '2022-07-26', '2022-07-27', '2022-07-28',
                   '2022-07-29', '2022-07-30', '2022-07-31', '2022-08-01',
                   '2022-08-02', '2022-08-03', '2022-08-04', '2022-08-05',
                   '2022-08-06', '2022-08-07', '2022-08-08', '2022-08-09',
                   '2022-08-10', '2022-08-11', '2022-08-12', '2022-08-13',
                   '2022-08-14', '2022-08-15', '2022-08-16', '2022-08-17',
                   '2022-08-18', '2022-08-19', '2022-08-20', '2022-08-21',
                   '2022-08-22', '2022-08-23', '2022-08-24', '2022-08-25',
                   '2022-08-26', '2022-08-27', '2022-08-28', '2022-08-29',
                   '2022-08-30', '2022-08-31', '2022-09-01', '2022-09-02',
                   '2022-09-03', '2022-09-04', '2022-09-05', '2022-09-06',
                   '2022-09-07', '2022-09-08', '2022-09-09', '2022-09-10',
                   '2022-09-11', '2022-09-12', '2022-09-13', '2022-09-14',
                   '2022-09-15', '2022-09-16', '2022-09-17', '2022-09-18',
                   '2022-09-19', '2022-09-20', '2022-09-21', '2022-09-22'],
                  dtype='datetime64[ns]', name='ts', freq=None)



如果测量值行中存在空值，将无法进行空间Kendall’s Tau计算，因此移除存在空值的行。原国家数含114个，有空值的行为5个，有效国家行为109个。


```python
aqi_world_gdf_pivot.dropna(inplace=True)
aqi_world_gdf_pivot.shape
```




    (109, 64)



`giddy`库提供的`giddy.rank.Tau`经典Kendall’s Tau计算和`giddy.rank.SpatialTau`空间Kendall’s Tau计算，计算模式为一次提供两组等级数列，以`2022-07-21`和`2022-09-22`两列AQI测量值为例计算。首先计算经典的Kendall’s Tau值，其结果为0.527，p-value值几近为0，因此该两个时期AQI数据具有相关性。


```python
from datetime import datetime
str2datetime=lambda dt_str:datetime.strptime(dt_str,'%Y-%m-%d')
dt1=str2datetime('2022-07-21')
dt2=str2datetime('2022-09-22')
```

* `giddy.rank.Tau`经典Kendall’s Tau


```python
import giddy
aqi_world_tau=giddy.rank.Tau(aqi_world_gdf_pivot[dt1],aqi_world_gdf_pivot[dt2]) 
```


```python
giddy_rank_tau_info_print=lambda tau:print(f"concordant: {tau.concordant};\ndiscordant: {tau.discordant};\ntau: {tau.tau};\ntau p-value: {tau.tau_p}")
giddy_rank_tau_info_print(aqi_world_tau)
```

    concordant: 4471.0;
    discordant: 1375.0;
    tau: 0.5278322873099652;
    tau p-value: 4.1083562233353125e-16
    

空间Kendall’s Tau计算需要输入空间权重值，以国家所属大洲为分组计算`block_weights`空间权重。为方便`Country`和`continent`数据提取，将其行索引值转换为列。


```python
aqi_world_gdf_pivot.index
```




    MultiIndex([('AQI Value',                  'Albania',        'Europe'),
                ('AQI Value',                  'Algeria',        'Africa'),
                ('AQI Value',                   'Angola',        'Africa'),
                ('AQI Value',                'Argentina', 'South America'),
                ('AQI Value',                  'Armenia',          'Asia'),
                ('AQI Value',                'Australia',       'Oceania'),
                ('AQI Value',                  'Austria',        'Europe'),
                ('AQI Value',               'Azerbaijan',          'Asia'),
                ('AQI Value',               'Bangladesh',          'Asia'),
                ('AQI Value',                  'Belarus',        'Europe'),
                ...
                ('AQI Value',                     'Togo',        'Africa'),
                ('AQI Value',      'Trinidad and Tobago', 'North America'),
                ('AQI Value',                   'Turkey',          'Asia'),
                ('AQI Value',                   'Uganda',        'Africa'),
                ('AQI Value',                  'Ukraine',        'Europe'),
                ('AQI Value',     'United Arab Emirates',          'Asia'),
                ('AQI Value',           'United Kingdom',        'Europe'),
                ('AQI Value', 'United States of America', 'North America'),
                ('AQI Value',                  'Vietnam',          'Asia'),
                ('AQI Value',                   'Zambia',        'Africa')],
               names=[None, 'Country', 'continent'], length=109)




```python
aqi_world_gdf_pivot.reset_index(level=['Country','continent'],inplace=True)
```


```python
aqi_world_gdf_pivot
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>ts</th>
      <th>Country</th>
      <th>continent</th>
      <th>2022-07-21 00:00:00</th>
      <th>2022-07-22 00:00:00</th>
      <th>2022-07-23 00:00:00</th>
      <th>2022-07-24 00:00:00</th>
      <th>2022-07-25 00:00:00</th>
      <th>2022-07-26 00:00:00</th>
      <th>2022-07-27 00:00:00</th>
      <th>2022-07-28 00:00:00</th>
      <th>...</th>
      <th>2022-09-13 00:00:00</th>
      <th>2022-09-14 00:00:00</th>
      <th>2022-09-15 00:00:00</th>
      <th>2022-09-16 00:00:00</th>
      <th>2022-09-17 00:00:00</th>
      <th>2022-09-18 00:00:00</th>
      <th>2022-09-19 00:00:00</th>
      <th>2022-09-20 00:00:00</th>
      <th>2022-09-21 00:00:00</th>
      <th>2022-09-22 00:00:00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AQI Value</th>
      <td>Albania</td>
      <td>Europe</td>
      <td>15.5</td>
      <td>16.666667</td>
      <td>17.5</td>
      <td>18.0</td>
      <td>55.0</td>
      <td>43.0</td>
      <td>41.0</td>
      <td>61.0</td>
      <td>...</td>
      <td>7.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>28.0</td>
      <td>11.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>9.5</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Algeria</td>
      <td>Africa</td>
      <td>65.0</td>
      <td>65.000000</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>...</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Angola</td>
      <td>Africa</td>
      <td>132.5</td>
      <td>123.333333</td>
      <td>107.0</td>
      <td>107.0</td>
      <td>117.0</td>
      <td>102.5</td>
      <td>123.0</td>
      <td>152.0</td>
      <td>...</td>
      <td>70.0</td>
      <td>77.0</td>
      <td>115.0</td>
      <td>117.0</td>
      <td>98.0</td>
      <td>82.0</td>
      <td>91.0</td>
      <td>87.0</td>
      <td>91.0</td>
      <td>87.5</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Argentina</td>
      <td>South America</td>
      <td>62.0</td>
      <td>57.333333</td>
      <td>55.5</td>
      <td>42.0</td>
      <td>74.0</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>23.0</td>
      <td>...</td>
      <td>47.0</td>
      <td>39.0</td>
      <td>23.0</td>
      <td>33.0</td>
      <td>18.0</td>
      <td>29.0</td>
      <td>21.0</td>
      <td>28.0</td>
      <td>61.0</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Armenia</td>
      <td>Asia</td>
      <td>77.0</td>
      <td>52.666667</td>
      <td>41.5</td>
      <td>43.0</td>
      <td>78.0</td>
      <td>61.0</td>
      <td>58.0</td>
      <td>63.0</td>
      <td>...</td>
      <td>76.0</td>
      <td>69.0</td>
      <td>90.0</td>
      <td>62.0</td>
      <td>45.0</td>
      <td>52.0</td>
      <td>67.0</td>
      <td>64.0</td>
      <td>65.0</td>
      <td>59.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>United Arab Emirates</td>
      <td>Asia</td>
      <td>91.0</td>
      <td>84.333333</td>
      <td>89.5</td>
      <td>174.0</td>
      <td>115.0</td>
      <td>289.0</td>
      <td>108.0</td>
      <td>120.0</td>
      <td>...</td>
      <td>118.0</td>
      <td>101.0</td>
      <td>83.0</td>
      <td>94.0</td>
      <td>99.0</td>
      <td>93.0</td>
      <td>83.0</td>
      <td>95.0</td>
      <td>129.0</td>
      <td>103.5</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>United Kingdom</td>
      <td>Europe</td>
      <td>55.0</td>
      <td>46.333333</td>
      <td>41.5</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>34.0</td>
      <td>36.0</td>
      <td>53.0</td>
      <td>...</td>
      <td>54.0</td>
      <td>63.0</td>
      <td>54.0</td>
      <td>41.0</td>
      <td>47.0</td>
      <td>36.0</td>
      <td>38.0</td>
      <td>46.0</td>
      <td>52.0</td>
      <td>57.0</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>United States of America</td>
      <td>North America</td>
      <td>111.5</td>
      <td>89.666667</td>
      <td>86.5</td>
      <td>85.0</td>
      <td>84.0</td>
      <td>78.5</td>
      <td>90.0</td>
      <td>80.0</td>
      <td>...</td>
      <td>162.0</td>
      <td>151.0</td>
      <td>105.0</td>
      <td>364.0</td>
      <td>122.0</td>
      <td>92.0</td>
      <td>92.0</td>
      <td>98.0</td>
      <td>110.0</td>
      <td>104.5</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Vietnam</td>
      <td>Asia</td>
      <td>42.0</td>
      <td>85.333333</td>
      <td>103.0</td>
      <td>92.0</td>
      <td>84.0</td>
      <td>74.0</td>
      <td>107.0</td>
      <td>118.0</td>
      <td>...</td>
      <td>143.0</td>
      <td>138.0</td>
      <td>109.0</td>
      <td>93.0</td>
      <td>102.0</td>
      <td>102.0</td>
      <td>97.0</td>
      <td>116.0</td>
      <td>110.0</td>
      <td>70.5</td>
    </tr>
    <tr>
      <th>AQI Value</th>
      <td>Zambia</td>
      <td>Africa</td>
      <td>46.5</td>
      <td>67.333333</td>
      <td>80.0</td>
      <td>152.0</td>
      <td>89.0</td>
      <td>64.5</td>
      <td>89.0</td>
      <td>91.0</td>
      <td>...</td>
      <td>176.0</td>
      <td>118.0</td>
      <td>116.0</td>
      <td>99.0</td>
      <td>107.0</td>
      <td>117.0</td>
      <td>184.0</td>
      <td>155.0</td>
      <td>151.0</td>
      <td>147.5</td>
    </tr>
  </tbody>
</table>
<p>109 rows × 66 columns</p>
</div>



* `giddy.rank.SpatialTau`空间Kendall’s Tau


```python
from libpysal.weights import block_weights
w=block_weights(aqi_world_gdf_pivot["continent"])
```


```python
np.random.seed(12345)
aqi_world_tau_w=giddy.rank.SpatialTau(aqi_world_gdf_pivot_m[dt1],aqi_world_gdf_pivot_m[dt2],w,999) 
```

空间Kendall’s Tau计算结果为1，p-value为0.001，拒绝等级交换空间随机性的无效假设，表明按照大洲分组空间单元，两组等级数列间完美相关，有大量等级交换发生在同一大洲的不同国家间。    


```python
giddy_rank_spatialTau_info_print=lambda stau:print(f"concordant: {stau.concordant};\nconcordant spatial: {stau.concordant_spatial};\ndiscordant: {stau.discordant};\ndiscordant spatial: {stau.discordant_spatial};\ntau spatial: {stau.tau_spatial};\ntau spatial psim: {stau.tau_spatial_psim}")
giddy_rank_spatialTau_info_print(aqi_world_tau_w)
```

    concordant: 22538311.0;
    concordant spatial: 685;
    discordant: 6931375.0;
    discordant spatial: 0;
    tau spatial: 1.0;
    tau spatial psim: 0.001
    

* `giddy.rank.Tau_Regional` 区域（分组）间和区域内Kendall’s Tau的分解

Kendall's τ的区域间和区域内分解提供了一个关于交换流动模式的中观视角。该方法不是考察整个研究区域内任何两个相邻空间单元之间的协和关系，而是区域内任何两个空间单元（邻里单元）之间的协和关系，例如Asia大洲，得出Asia大洲区域内的协和统计；也可以考察区域间例如Asia大洲和Europe大洲非邻里单元之间的协和关系，从而得出区域间的协和统计。进而可以寻找到承载最多等级交换的特定区域。如果有k个区域，就会有k个区域内协和统计量，和$(k-1)^{2} $个区域间协和统计量。可以将上述区域间和区域内协和统计量组织成一个$(k,k)$矩阵，其中对角线元素是区域内协和统计量，非对角线元素是区域间协和统计量，其公式为：$T=\frac{P(H \circ S)P'}{P H P'}$，式中，$P$是一个$(k,n)$二元矩阵，如果空间单元$i$在$j$区域，则$p_{j,i}=1$，否则$p_{j,i}=0$；$H$是一个$(n,n)$矩阵，对角线上的值为0，其它位置值为1； $\circ$ 为哈达玛积（Hadamard Product），当两个矩阵为同阶矩阵时，两矩阵的哈达玛积为对应位置元素相乘。

计算结果属性`tau_reg`给出了区域间和区域内协和统计矩阵，较高的数值代表较低的交换流动性；负值则为较高的交换流动性。属性`tau_reg_pvalues`返回p-value。配置显著性水平为0.05，不满足要求的位置赋值为0，可以观察区域间和区域内有效协和统计矩阵值。


```python
np.random.seed(12345)

aqi_world_tau_regional_w=giddy.rank.Tau_Regional(aqi_world_gdf_pivot[dt1],aqi_world_gdf_pivot[dt2],aqi_world_gdf_pivot['continent'],999) 
```


```python
aqi_world_tau_regional_w.tau_reg.round(3)
```




    array([[ 0.255,  0.343,  0.619,  0.617,  0.889, -0.016],
           [ 0.343,  0.568,  0.627,  0.626,  0.752,  0.261],
           [ 0.619,  0.627,  0.538,  0.622,  0.426,  0.353],
           [ 0.617,  0.626,  0.622,  0.733,  0.6  ,  0.4  ],
           [ 0.889,  0.752,  0.426,  0.6  ,  0.333,  0.524],
           [-0.016,  0.261,  0.353,  0.4  ,  0.524,  0.19 ]])




```python
aqi_world_tau_regional_w.tau_reg_pvalues
```




    array([[0.023, 0.003, 0.055, 0.179, 0.01 , 0.001],
           [0.003, 0.303, 0.005, 0.096, 0.071, 0.005],
           [0.055, 0.005, 0.465, 0.097, 0.237, 0.051],
           [0.179, 0.096, 0.097, 0.135, 0.458, 0.215],
           [0.01 , 0.071, 0.237, 0.458, 0.518, 0.544],
           [0.001, 0.005, 0.051, 0.215, 0.544, 0.114]])




```python
aqi_world_tau_regional_w_significant=aqi_world_tau_regional_w.tau_reg * (aqi_world_tau_regional_w.tau_reg_pvalues<0.05)
aqi_world_tau_regional_w_significant.round(3)
```




    array([[ 0.255,  0.343,  0.   ,  0.   ,  0.889, -0.016],
           [ 0.343,  0.   ,  0.627,  0.   ,  0.   ,  0.261],
           [ 0.   ,  0.627,  0.   ,  0.   ,  0.   ,  0.   ],
           [ 0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ],
           [ 0.889,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ],
           [-0.016,  0.261,  0.   ,  0.   ,  0.   ,  0.   ]])



* giddy.rank.Tau_Local 局部Kendall’s Tau 

局部Kendall’s Tau 是经典Kendall’s Tau的局部分解，提供了空间单元$ r$的等级变化对整体交换流动水平的贡献<sup>[10]</sup>。对于空间单元$r$，其公式为：$\tau_{r} = \frac{c_r - d_r}{n-1}$，式中$c_r$是除了空间单元$r$外的空间单元与$r$空间单元的协和对数量；$d_r$是不协和对的数量。$\tau_{r}$值位于[-1,1]区间，值越大，单元$r$的交换流动性越低。

下述计算结果显示了排序后前后5行的局部Kendall’s Tau值，Bolivia值为-0.380，表明Bolivia在2022-07-21和2022-09-21两列AQI观测值间与很多国家交换了排名；相反，Puerto Rico值为0.991，凸显了Puerto Rico的AQI排名的高度稳定性。


```python
tau_r=giddy.rank.Tau_Local(aqi_world_gdf_pivot[dt1],aqi_world_gdf_pivot[dt2])
local_tau=pd.DataFrame({"Country":aqi_world_gdf_pivot['Country'].tolist(),"$\\tau_r$":tau_r.tau_local})
local_tau.sort_values(by=["$\\tau_r$"]).round(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Country</th>
      <th>$\tau_r$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12</th>
      <td>Bolivia</td>
      <td>-0.380</td>
    </tr>
    <tr>
      <th>108</th>
      <td>Zambia</td>
      <td>-0.120</td>
    </tr>
    <tr>
      <th>68</th>
      <td>Mongolia</td>
      <td>-0.056</td>
    </tr>
    <tr>
      <th>57</th>
      <td>Kyrgyzstan</td>
      <td>0.009</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Burkina Faso</td>
      <td>0.037</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>83</th>
      <td>Qatar</td>
      <td>0.907</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Iraq</td>
      <td>0.926</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Iran</td>
      <td>0.926</td>
    </tr>
    <tr>
      <th>43</th>
      <td>Iceland</td>
      <td>0.981</td>
    </tr>
    <tr>
      <th>82</th>
      <td>Puerto Rico</td>
      <td>0.991</td>
    </tr>
  </tbody>
</table>
<p>109 rows × 2 columns</p>
</div>



* `giddy.rank.Tau_Local_Neighbor`流动性关联的局部指标（Local indicator of mobility association，LIMA）

为了揭示空间在塑造每个空间单元间的交换流动模式方面的作用，使用局部Kendall’s Tau的两个空间变体：neighbor（邻居） set LIMA 和neighborhood （邻里）set LIMA<sup>[10]</sup>。邻里变体是局部Kendall’s Tau分解（相邻和不相邻）和空间Kendall’s Tau分解的共同结果。

__Neighbor set LIMA（邻居）__

Neighbor变体不像局部Kendall’s Tau的计算方式，分析一个目标空间单元$r$与所有其它空间单元之间的协和关系，而是分析目标空间单元$r$和其邻接空间单元之间的协和关系，其公式定义如下：$\tilde{\tau}_{r} = \frac{\sum_b w_{r,b} s_{r,b}}{\sum_b w_{r,b}}$，式中，$w_{r,b}$为目标单元$r$与邻接单元$b$之间的空间权重；$s_{r,b}$为空间单元$r$与邻接单元$b$的协和对矩阵。


```python
aqi_world_tau_local_neighbor_w=giddy.rank.Tau_Local_Neighbor(aqi_world_gdf_pivot[dt1],aqi_world_gdf_pivot[dt2],w,999) 
```


```python
aqi_world_tau_local_neighbor_w.tau_ln.round(3).shape
```




    (109,)



使用`pivot_table`转换GeoDataFrame数据时，并未链接`geometry`的地理数据信息，因此需要单独通过`merge`方法合并并配置投影，同时将Neighbor set LIMA计算结果置入其中，用于地图打印。


```python
aqi_world_gdf_pivot['tau_ln']=aqi_world_tau_local_neighbor_w.tau_ln
aqi_world_gdf_pivot_df=pd.merge(aqi_world_gdf_pivot,world,how='left',left_on=['Country'],right_on=['name'])
aqi_world_gdf_pivot_gdf=gpd.GeoDataFrame(aqi_world_gdf_pivot_df,geometry='geometry',crs=world.crs)
aqi_world_gdf_pivot_gdf
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Country</th>
      <th>continent_x</th>
      <th>2022-07-21 00:00:00</th>
      <th>2022-07-22 00:00:00</th>
      <th>2022-07-23 00:00:00</th>
      <th>2022-07-24 00:00:00</th>
      <th>2022-07-25 00:00:00</th>
      <th>2022-07-26 00:00:00</th>
      <th>2022-07-27 00:00:00</th>
      <th>2022-07-28 00:00:00</th>
      <th>...</th>
      <th>2022-09-20 00:00:00</th>
      <th>2022-09-21 00:00:00</th>
      <th>2022-09-22 00:00:00</th>
      <th>tau_ln</th>
      <th>pop_est</th>
      <th>continent_y</th>
      <th>name</th>
      <th>iso_a3</th>
      <th>gdp_md_est</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Albania</td>
      <td>Europe</td>
      <td>15.5</td>
      <td>16.666667</td>
      <td>17.5</td>
      <td>18.0</td>
      <td>55.0</td>
      <td>43.0</td>
      <td>41.0</td>
      <td>61.0</td>
      <td>...</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>9.5</td>
      <td>0.857143</td>
      <td>2854191.0</td>
      <td>Europe</td>
      <td>Albania</td>
      <td>ALB</td>
      <td>15279</td>
      <td>POLYGON ((21.02004 40.84273, 20.99999 40.58000...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Algeria</td>
      <td>Africa</td>
      <td>65.0</td>
      <td>65.000000</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>...</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>65.0</td>
      <td>0.411765</td>
      <td>43053054.0</td>
      <td>Africa</td>
      <td>Algeria</td>
      <td>DZA</td>
      <td>171091</td>
      <td>POLYGON ((-8.68440 27.39574, -8.66512 27.58948...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Angola</td>
      <td>Africa</td>
      <td>132.5</td>
      <td>123.333333</td>
      <td>107.0</td>
      <td>107.0</td>
      <td>117.0</td>
      <td>102.5</td>
      <td>123.0</td>
      <td>152.0</td>
      <td>...</td>
      <td>87.0</td>
      <td>91.0</td>
      <td>87.5</td>
      <td>0.411765</td>
      <td>31825295.0</td>
      <td>Africa</td>
      <td>Angola</td>
      <td>AGO</td>
      <td>88815</td>
      <td>MULTIPOLYGON (((12.99552 -4.78110, 12.63161 -4...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Argentina</td>
      <td>South America</td>
      <td>62.0</td>
      <td>57.333333</td>
      <td>55.5</td>
      <td>42.0</td>
      <td>74.0</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>23.0</td>
      <td>...</td>
      <td>28.0</td>
      <td>61.0</td>
      <td>22.0</td>
      <td>0.000000</td>
      <td>44938712.0</td>
      <td>South America</td>
      <td>Argentina</td>
      <td>ARG</td>
      <td>445445</td>
      <td>MULTIPOLYGON (((-68.63401 -52.63637, -68.25000...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Armenia</td>
      <td>Asia</td>
      <td>77.0</td>
      <td>52.666667</td>
      <td>41.5</td>
      <td>43.0</td>
      <td>78.0</td>
      <td>61.0</td>
      <td>58.0</td>
      <td>63.0</td>
      <td>...</td>
      <td>64.0</td>
      <td>65.0</td>
      <td>59.0</td>
      <td>0.382353</td>
      <td>2957731.0</td>
      <td>Asia</td>
      <td>Armenia</td>
      <td>ARM</td>
      <td>13672</td>
      <td>POLYGON ((46.50572 38.77061, 46.14362 38.74120...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>104</th>
      <td>United Arab Emirates</td>
      <td>Asia</td>
      <td>91.0</td>
      <td>84.333333</td>
      <td>89.5</td>
      <td>174.0</td>
      <td>115.0</td>
      <td>289.0</td>
      <td>108.0</td>
      <td>120.0</td>
      <td>...</td>
      <td>95.0</td>
      <td>129.0</td>
      <td>103.5</td>
      <td>0.500000</td>
      <td>9770529.0</td>
      <td>Asia</td>
      <td>United Arab Emirates</td>
      <td>ARE</td>
      <td>421142</td>
      <td>POLYGON ((51.57952 24.24550, 51.75744 24.29407...</td>
    </tr>
    <tr>
      <th>105</th>
      <td>United Kingdom</td>
      <td>Europe</td>
      <td>55.0</td>
      <td>46.333333</td>
      <td>41.5</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>34.0</td>
      <td>36.0</td>
      <td>53.0</td>
      <td>...</td>
      <td>46.0</td>
      <td>52.0</td>
      <td>57.0</td>
      <td>0.485714</td>
      <td>66834405.0</td>
      <td>Europe</td>
      <td>United Kingdom</td>
      <td>GBR</td>
      <td>2829108</td>
      <td>MULTIPOLYGON (((-6.19788 53.86757, -6.95373 54...</td>
    </tr>
    <tr>
      <th>106</th>
      <td>United States of America</td>
      <td>North America</td>
      <td>111.5</td>
      <td>89.666667</td>
      <td>86.5</td>
      <td>85.0</td>
      <td>84.0</td>
      <td>78.5</td>
      <td>90.0</td>
      <td>80.0</td>
      <td>...</td>
      <td>98.0</td>
      <td>110.0</td>
      <td>104.5</td>
      <td>1.000000</td>
      <td>328239523.0</td>
      <td>North America</td>
      <td>United States of America</td>
      <td>USA</td>
      <td>21433226</td>
      <td>MULTIPOLYGON (((-122.84000 49.00000, -120.0000...</td>
    </tr>
    <tr>
      <th>107</th>
      <td>Vietnam</td>
      <td>Asia</td>
      <td>42.0</td>
      <td>85.333333</td>
      <td>103.0</td>
      <td>92.0</td>
      <td>84.0</td>
      <td>74.0</td>
      <td>107.0</td>
      <td>118.0</td>
      <td>...</td>
      <td>116.0</td>
      <td>110.0</td>
      <td>70.5</td>
      <td>0.647059</td>
      <td>96462106.0</td>
      <td>Asia</td>
      <td>Vietnam</td>
      <td>VNM</td>
      <td>261921</td>
      <td>POLYGON ((104.33433 10.48654, 105.19991 10.889...</td>
    </tr>
    <tr>
      <th>108</th>
      <td>Zambia</td>
      <td>Africa</td>
      <td>46.5</td>
      <td>67.333333</td>
      <td>80.0</td>
      <td>152.0</td>
      <td>89.0</td>
      <td>64.5</td>
      <td>89.0</td>
      <td>91.0</td>
      <td>...</td>
      <td>155.0</td>
      <td>151.0</td>
      <td>147.5</td>
      <td>-0.411765</td>
      <td>17861030.0</td>
      <td>Africa</td>
      <td>Zambia</td>
      <td>ZMB</td>
      <td>23309</td>
      <td>POLYGON ((30.74001 -8.34001, 31.15775 -8.59458...</td>
    </tr>
  </tbody>
</table>
<p>109 rows × 73 columns</p>
</div>



根据LIMA数值分布，从地图中可以得出，负值的国家例如Mongolia、Chile等国家与大部分邻接的国家交换了排名（等级）；而正值较大的数值，例如China、United States of America等与邻接的国家几乎没有交换过等级。


```python
import util_misc

util_misc.gdf_plot_annotate(aqi_world_gdf_pivot_gdf,"tau_ln","Country",annotate_fontsize=7,scheme="equal_interval",k=5,figsize=(20,8),legend_bbox_to_anchor=(0.1, 0.22))
```

<img src="./imgs/2_7_5/output_67_0.png" height='auto' width='auto' title="caDesign">
    


考虑到统计显著性水平（0.05），仅保留具有统计显著性的结果，可以从地图中得知，Chile为等级交换的热点，意味着Chile更倾向于与邻接国家交换等级而不是其它国家；相反，Russia等国家更倾向于与非邻接国家交换等级，而不是邻接国家。


```python
aqi_world_tau_local_neighbor_w.tau_ln_pvalues
```




    array([0.398, 0.346, 0.157, 0.372, 0.248, 0.594, 0.062, 0.001, 0.51 ,
           0.001, 0.143, 0.481, 0.076, 0.431, 0.185, 0.084, 0.118, 0.186,
           0.303, 0.144, 0.023, 0.135, 0.614, 0.417, 0.025, 0.478, 0.045,
           0.356, 0.01 , 0.137, 0.287, 0.468, 0.213, 0.061, 0.07 , 0.236,
           0.011, 0.043, 0.543, 0.002, 0.554, 0.634, 0.05 , 0.69 , 0.273,
           0.17 , 0.007, 0.006, 0.012, 0.009, 0.002, 0.209, 0.048, 0.364,
           0.553, 0.088, 0.048, 0.264, 0.001, 0.072, 0.548, 0.328, 0.019,
           0.475, 0.35 , 0.499, 0.112, 0.01 , 0.454, 0.544, 0.011, 0.21 ,
           0.096, 0.389, 0.226, 0.004, 0.026, 0.331, 0.595, 0.461, 0.236,
           0.008, 0.926, 0.177, 0.255, 0.002, 0.104, 0.459, 0.149, 0.473,
           0.005, 0.439, 0.021, 0.065, 0.084, 0.002, 0.245, 0.074, 0.587,
           0.047, 0.693, 0.522, 0.17 , 0.002, 0.27 , 0.44 , 0.192, 0.02 ,
           0.155])




```python
saqi_world_tau_local_neighbor_w_significant=aqi_world_tau_local_neighbor_w.tau_ln * (aqi_world_tau_local_neighbor_w.tau_ln_pvalues<0.05)
saqi_world_tau_local_neighbor_w_significant.round(3)
```




    array([ 0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.765,
            0.   ,  0.2  ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,
           -0.   ,  0.   ,  0.   ,  0.   , -0.667,  0.   ,  0.   ,  0.   ,
            0.371,  0.   ,  0.429,  0.   ,  0.176,  0.   ,  0.   ,  0.   ,
            0.   ,  0.   ,  0.   ,  0.   ,  0.735,  0.6  ,  0.   ,  0.257,
            0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.765,  0.765,
            0.514, -0.147,  0.486,  0.   ,  0.882,  0.   ,  0.   ,  0.   ,
            0.529,  0.   ,  0.824,  0.   ,  0.   ,  0.   ,  0.486,  0.   ,
            0.   ,  0.   ,  0.   ,  0.371,  0.   ,  0.   ,  0.794,  0.   ,
            0.   ,  0.   ,  0.   ,  0.059,  0.714,  0.   ,  0.   ,  0.   ,
            0.   ,  0.429,  0.   ,  0.   ,  0.   ,  0.829,  0.   ,  0.   ,
            0.   ,  0.   ,  0.176,  0.   ,  0.829,  0.   ,  0.   ,  0.229,
            0.   ,  0.   ,  0.   , -0.294,  0.   ,  0.   ,  0.   ,  0.   ,
            0.   ,  0.   ,  0.   ,  0.647, -0.   ])




```python
aqi_world_gdf_pivot_gdf['sig_wr']=saqi_world_tau_local_neighbor_w_significant
```


```python
import matplotlib.pyplot as plt

fig, ax=plt.subplots(nrows=1, ncols=1,figsize = (20,8))
aqi_world_gdf_pivot_gdf[aqi_world_gdf_pivot_gdf["sig_wr"]==0].plot(ax=ax, color='white',edgecolor='black')
sig_ln_map=aqi_world_gdf_pivot_gdf[aqi_world_gdf_pivot_gdf["sig_wr"] != 0].plot(ax=ax,column="sig_wr",cmap='coolwarm',scheme='equal_interval',legend=True)
leg=ax.get_legend()
leg.set_bbox_to_anchor((0, 0.1, 0.16, 0.2))
sig_ln_map.set_title("Significant Neighbor set LIMA for world AQI",fontdict={"fontsize":20})
ax.set_axis_off()
```

<img src="./imgs/2_7_5/output_72_0.png" height='auto' width='auto' title="caDesign">
    



__Neighborhood set LIMA（邻里）__

Neighborhood变体是对Neighbor变体的拓展，不只是分析目标空间单元$𝑟$和其邻接空间单元之间的协和关系，而是拓展到目标空间单元$𝑟$及其邻里空间单元组成的子集中任何两个空间单元之间的协和关系。


```python
aqi_world_tau_local_neighborhood_w=giddy.rank.Tau_Local_Neighborhood(aqi_world_gdf_pivot[dt1],aqi_world_gdf_pivot[dt2],w,999) 
```


```python
aqi_world_tau_local_neighborhood_w.tau_lnhood
```




    array([0.53809524, 0.25490196, 0.25490196, 0.19047619, 0.56806723,
           0.33333333, 0.53809524, 0.56806723, 0.56806723, 0.53809524,
           0.53809524, 0.73333333, 0.19047619, 0.19047619, 0.56806723,
           0.53809524, 0.25490196, 0.56806723, 0.73333333, 0.25490196,
           0.19047619, 0.56806723, 0.19047619, 0.73333333, 0.53809524,
           0.56806723, 0.53809524, 0.19047619, 0.25490196, 0.73333333,
           0.53809524, 0.25490196, 0.53809524, 0.53809524, 0.25490196,
           0.25490196, 0.56806723, 0.53809524, 0.25490196, 0.53809524,
           0.73333333, 0.73333333, 0.53809524, 0.53809524, 0.56806723,
           0.56806723, 0.56806723, 0.56806723, 0.53809524, 0.56806723,
           0.53809524, 0.56806723, 0.56806723, 0.56806723, 0.25490196,
           0.53809524, 0.56806723, 0.56806723, 0.56806723, 0.53809524,
           0.56806723, 0.25490196, 0.53809524, 0.53809524, 0.25490196,
           0.56806723, 0.73333333, 0.53809524, 0.56806723, 0.53809524,
           0.56806723, 0.56806723, 0.53809524, 0.33333333, 0.33333333,
           0.25490196, 0.53809524, 0.56806723, 0.19047619, 0.56806723,
           0.53809524, 0.53809524, 0.73333333, 0.56806723, 0.53809524,
           0.53809524, 0.25490196, 0.53809524, 0.53809524, 0.53809524,
           0.25490196, 0.56806723, 0.53809524, 0.56806723, 0.53809524,
           0.53809524, 0.56806723, 0.56806723, 0.56806723, 0.25490196,
           0.73333333, 0.56806723, 0.25490196, 0.53809524, 0.56806723,
           0.53809524, 0.73333333, 0.56806723, 0.25490196])




```python
aqi_world_gdf_pivot_gdf['tau_lnhood']=aqi_world_tau_local_neighborhood_w.tau_lnhood
```

从地图打印LIMA（邻里）结果来看，非洲和南美洲的国家邻里之间具有相对较高的等级交换；而北美具有较高稳定性，邻里之间的等级交换较少。


```python
util_misc.gdf_plot_annotate(aqi_world_gdf_pivot_gdf,"tau_lnhood","Country",annotate_fontsize=7,scheme="equal_interval",k=5,figsize=(20,8),legend_bbox_to_anchor=(0.1, 0.22))
```

<img src="./imgs/2_7_5/output_78_0.png" height='auto' width='auto' title="caDesign">
    



```python
aqi_world_tau_local_neighborhood_w.tau_lnhood_pvalues
```




    array([0.49 , 0.027, 0.016, 0.135, 0.299, 0.483, 0.418, 0.217, 0.357,
           0.469, 0.438, 0.138, 0.334, 0.13 , 0.387, 0.505, 0.035, 0.357,
           0.158, 0.023, 0.138, 0.375, 0.124, 0.125, 0.475, 0.292, 0.48 ,
           0.135, 0.016, 0.109, 0.494, 0.016, 0.493, 0.457, 0.029, 0.008,
           0.294, 0.431, 0.038, 0.444, 0.185, 0.134, 0.459, 0.464, 0.359,
           0.324, 0.377, 0.396, 0.496, 0.212, 0.332, 0.282, 0.292, 0.224,
           0.04 , 0.442, 0.334, 0.185, 0.227, 0.495, 0.276, 0.016, 0.495,
           0.469, 0.04 , 0.31 , 0.155, 0.476, 0.166, 0.5  , 0.291, 0.323,
           0.475, 0.569, 0.432, 0.016, 0.434, 0.315, 0.073, 0.33 , 0.398,
           0.493, 0.267, 0.371, 0.451, 0.405, 0.019, 0.433, 0.439, 0.463,
           0.022, 0.312, 0.449, 0.262, 0.482, 0.481, 0.286, 0.27 , 0.328,
           0.043, 0.18 , 0.296, 0.024, 0.44 , 0.331, 0.452, 0.168, 0.262,
           0.047])




```python
aqi_world_tau_local_neighborhood_w_significant=aqi_world_tau_local_neighborhood_w.tau_lnhood * (aqi_world_tau_local_neighborhood_w.tau_lnhood_pvalues<0.05)
aqi_world_tau_local_neighborhood_w_significant.round(3)
```




    array([0.   , 0.255, 0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.255, 0.   ,
           0.   , 0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.   , 0.255, 0.   , 0.   , 0.255, 0.   , 0.   , 0.255, 0.255,
           0.   , 0.   , 0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.255, 0.   ,
           0.   , 0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.   , 0.   , 0.   , 0.255, 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.   , 0.   , 0.   , 0.   , 0.   , 0.255, 0.   , 0.   , 0.   ,
           0.255, 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.255, 0.   , 0.   , 0.255, 0.   , 0.   , 0.   , 0.   , 0.   ,
           0.255])




```python
aqi_world_gdf_pivot_gdf['sig_lnhood']=aqi_world_tau_local_neighborhood_w_significant
```

考虑统计显著性，非洲具有相对一定邻里空间的等级交换。


```python
fig, ax=plt.subplots(nrows=1, ncols=1,figsize=(20,8))
aqi_world_gdf_pivot_gdf[aqi_world_gdf_pivot_gdf["sig_lnhood"] == 0].plot(ax=ax, color='white',edgecolor='black')
sig_ln_map=aqi_world_gdf_pivot_gdf[aqi_world_gdf_pivot_gdf["sig_lnhood"] != 0].plot(ax=ax,column="sig_lnhood",categorical=True,legend=True)
leg=ax.get_legend()
leg.set_bbox_to_anchor((0, 0.15, 0.16, 0.2))
sig_ln_map.set_title("Significant Neighborhood set LIMA for world AQI",fontdict={"fontsize":20})
ax.set_axis_off()
```

<img src="./imgs/2_7_5/output_83_0.png" height='auto' width='auto' title="caDesign">
    


---

注释（Notes）：

① Clean Air Act，（美国）清洁空气法（<https://en.wikipedia.org/wiki/Clean_Air_Act_(United_States)>）。

② Kaggle，数据科学家和机器学习从业者的在线社区（<https://www.kaggle.com/>）。

③ Kaggle-Wikipedia，（<https://en.wikipedia.org/wiki/Kaggle>）。

④ Air Quality Index Dataset，（<https://www.kaggle.com/datasets/pratikshapandapkp/air-quality-index-dataset>）。

⑤ Plotly，是一个通过数据应用实现数据驱动决策的实践者，构建有支持多种编程语言的图表库（<https://plotly.com/python/#controls>）。

⑥ Kendall’s Tau (Kendall Rank Correlation Coefficient——Statistics How To网站提供了初级统计学的知识内容（<https://www.statisticshowto.com/kendalls-tau/>）。

⑦ Rank based Methods，（<http://pysal.org/notebooks/explore/giddy/Rank_based_Methods.html>）。

⑧ `libpysal.weights.block_weights`空间权重，（<https://pysal.org/libpysal/generated/libpysal.weights.block_weights.html>）。

参考文献（References）:

[1] Air quality index, Wikipedia, <https://en.wikipedia.org/wiki/Air_quality_index>.

[2] "International Air Quality". Archived from the original on 12 June 2018. Retrieved 20 August 2015.

[3] "NOAA's National Weather Service/Environmental Protection Agency - United States Air Quality Forecast Guidance". airquality.weather.gov. Retrieved 2021-04-28.

[4]  "MACC Project - European Air Quality Monitoring and Forecasting". Archived from the original on 2014-10-18. Retrieved 2014-10-12.

[5] Technical Assistance Document for the Reporting of Daily Air Quality – the Air Quality Index (AQI)  (Report). U.S. Environmental Protection Agency. May 2016. EPA-454/B-16-002. Archived from the original on 2020-10-26. Retrieved 2020-08-20.

[6] David Mintz (September 2018). Technical Assistance Document for the Reporting of Daily Air Quality – the Air Quality Index (AQI). North Carolina: US EPA Office of Air Quality Planning and Standards. EPA-454/B-18-007. Retrieved 15 September 2021.

[7] Revised Air Quality Standards For Particle Pollution And Updates To The Air Quality Index (AQI). North Carolina: US EPA Office of Air Quality Planning and Standards. 2013.

[8]  "ENVIRONMENTAL PROTECTION AGENCY 40 CFR Parts 50, 51, 52, 53 and 58 [EPA-HQ-OAR-2008-0699; FRL-9913-18-OAR] RIN 2060-AP38 – National Ambient Air Quality Standards for Ozone". Environmental Protection Agency. Archived from the original on 2015-10-06. Retrieved 2015-10-05.

[9] Rey, Sergio J. 2014. “Fast Algorithms for a Space-Time Concordance Measure.” Computational Statistics 29 (3-4). Springer: 799–811.

[10] Rey, Sergio J. 2016. “Space--Time Patterns of Rank Concordance: Local Indicators of Mobility Association with Application to Spatial Income Inequality Dynamics.” Annals of the Association of American Geographers. Association of American Geographers 106 (4): 788–803.
