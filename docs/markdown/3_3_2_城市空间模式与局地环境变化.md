> Created on Wed Feb  2 20:18:06 2022 @author: Richie Bao-caDesign设计(cadesign.cn)

# 3.3.2 城市空间模式与局地环境变化

## A. 建立研究代码项目

1. 建立本地仓库与GitHub仓库

建立本地仓库（项目文件夹），命名为`PAPER_Urban_Spatial_Pattern_N_Local_Environmental_Changes`，并推送至GitHub端。链接地址：[PAPER_Urban_Spatial_Pattern_N_Local_Environmental_Changes](https://github.com/richieBao/PAPER_Urban_Spatial_Pattern_N_Local_Environmental_Changes)，`https://github.com/richieBao/PAPER_Urban_Spatial_Pattern_N_Local_Environmental_Changes`。


2. 建立数据库

使用[pgAdmin](https://www.pgadmin.org/)创建本地关系数据库`PAPER_Urban_Spatial_Pattern_N_Local_Environmental_Changes`，并在`Query Editor`中执行`CREATE EXTENSION postgis;`，使能够存储具有坐标系统的地理几何对象。随书写研究代码进展读写数据库。

完成项目后，从`pgAdmain`下导出（`Backup`）该数据库，可以发布，并从`pgAdmain`下导入（`Restore`）该项目数据库。也可以单独通过`Import/Export`导入，导出单独的表数据。


3. 建立配置文件

使用[YAML](https://en.wikipedia.org/wiki/YAML)文件格式，书写配置文件。


4. 项目文件结构


5. requirements文件

`requirements_install info.txt`
```txt

```


## B. 专项研究与代码实现

### B.1 背景



### B.2 研究方法与结果



#### B.2.1 研究区域


#### B.2.2 数据

| 序号  | 数据名称  | 数据来源  | 说明  |大小|数据类型|
|---|---|---|---|---|---|
| 1  | AoT_Chicago.complete.2021-12-20  | [Array of Things(AoT) 城市环境传感器](https://arrayofthings.github.io/)  |  主要包括：data, node,sensors及说明文件README  |data:39.5GB |.csv|
| 2  |  行政区域:Chicago Community Areas | [Chicago Data Portal](https://data.cityofchicago.org/)  | 方便定位传感器在城市中的位置 |/ |.shp|
| 3  | 建筑高度数据：Building Footprints (current)   | [Chicago Data Portal](https://data.cityofchicago.org/Buildings/Building-Footprints-current-/hz9b-7nh8)   | 用于建筑围合城市空间（城市峡谷）与城市环境测量值关系分析  |948MB|.geojson|
|  4 |道路中心线: Street Center Lines(current)  |[Chicago Data Portal](https://data.cityofchicago.org/Transportation/Street-Center-Lines/6imu-meau) |  探索道路类型、分布和密度等统计量与传感器测量值的关系 |72.1MB|.geojson|
|5|土地利用:Land Use Inventory for Northeast Illinois, 2015 |[CMAP DATA HUB](https://datahub.cmap.illinois.gov/group/land-use-inventories)|分析土地利用与传感器测量值的关系|553MB|.shp|
|6|芝加哥城边界: Boundaries - City| [Chicago Data Portal](https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-City/ewy2-6yfk)|研究边界|/|.shp|
|7|伊利诺伊州激光雷达数据|[伊利诺斯州草原地质调查研究所（Illinois state geological survey - prairie research institute）](https://www.arcgis.com/apps/webappviewer/index.html?id=44eb65c92c944f3e8b231eb1e2814f4d)|提取植被信息，含高中低三个分类|1.4T|.las|


##### B.2.2.1 数据获取及预处理


###### 1) 环境传感器说明

下载的AoT数据包括:

1. `data(data.csv.gz)`: 按时间戳升序排列的传感器测量数据;
2. `nodes.csv`: 节点元数据。主要包括节点的ID，经纬度，时间戳，信息描述等信息；
3. `sensors.csv`： 传感器元数据。 包括传感器测量内容，浓度单位，最小最大值，以及传感器说明文件；
4. `provenance.csv`：项目版本，起止时间和数据下地址等；
5. `README.md`：说明文件。对各文件的解释及数据参数的说明。

根据`sensors.csv`文件，分类测量内容为气体类、颗粒物、热环境、噪音、光、电磁场和惯性测量等内容。在后续分析过程中，将根据分类内容分别分析前5类。

| 序号  | 分类  | 测量内容  | 单位  | 说明  |
|---|---|---|---|---|
| 1  | 气体类  | CO（一氧化碳，carbon monoxide）  | ppm   | CO是一种无色、无味的气体。当大量吸入时，对人体造成伤害。某物燃烧时会释放CO，在户外，空气中的CO主要来源于燃烧化石燃料的各类汽车和机械；在户内未通风条件下，有泄露的煤油、燃气、烟筒、火炉等，影响室内空气质量。 <br>吸入高浓度CO，会减少血液中输送到心脏和大脑等关键器官的氧气量。在室内封闭环境下，会导致头晕、神志不清、昏迷和死亡；在户外，非常高浓度的CO不太可能发生，但是当达到一定水平，会对某些类型的心脏病患者造成特别影响。在健身或压力增大等心脏需要更多氧气条件下，导致进入心脏的氧气减少，并伴有胸痛（胸绞痛）。 |
| 2 |   |  H2S（硫化氢，Hydrogen Sulfide） | ppm  |  H2S是一种剧毒有害气体，透明、散发出臭鸡蛋的气味。这种气体具有高度的爆炸性，长时间暴漏在这种气体中可能会致命。H2S长存在于制造工厂、炼油厂和气体处理设施中。 |
| 3|   | NO<sub>2</sub>(二氧化氮, Nitrogen Dioxide)  | ppm  | NO<sub>2</sub>是一种气态的空气污染物，由氮和氧组成（氮氧化物）。当煤、石油、天然气或柴油等化石燃料在高温下燃烧时产生。 汽车是最大的排放源，其次是放电厂、柴油驱动的重型建筑设备和其它可移动发动机及工业锅炉。室外空气中的二氧化氮和其他氮氧化物会造成颗粒污染和产生臭氧的化学反应。 NO<sub>2</sub>会对肺部造成一系列有害影响，包括：气道炎症、咳嗽、气喘、降低肺功能、增加哮喘发作，对肺癌患者造成更大风险。同时，NO<sub>2</sub>与心血管疾病、新生儿出生体重过轻及过早死亡风险增加有关。<br>室内的煤油或燃气加热器和煤气炉灶也会大量产生NO<sub>2</sub>，如果没有完全排放到室外，室内浓度会升高。|
| 4  |   | O<sub>3</sub> (臭氧, trioxygen)  | ppm  |  O<sub>3</sub>由3个氧原子结合在一起，有一种特殊的刺鼻气味。因为自身不稳定在低层大气中分解为 O<sub>2</sub>。O<sub>3</sub>是由O<sub>2</sub>在地球大气中的紫外线（UV, ultraviolet）和放电作用下形成。它的浓度很低，在平流层的臭氧层（ozone layer）中浓度最高。臭氧层通过过滤大部分紫外线辐射保护地球生物。地面上的O<sub>3</sub>，通常是太阳光和汽车、工业等来源排放物相互作用产生，对人类的健康有害。例如， 对眼鼻喉和下呼吸道刺激和炎症（咳嗽、喉咙痛或胸部不舒服）；肺功能下降（不能像平常一样深呼吸或大力呼吸）；引起哮喘和慢性呼吸系统疾病；呼吸道感染的易感性增加。|
| 5  |   | oxidizing_gases（氧化气体）  | ppm  |  oxidizing_gases包括任何含氧高于大气浓度（23-25%）的气体，如氧化氮（nitrogen oxides）、卤素气体（halogen gases，如如氯（chlorine）和氟（fluorine）。）这些气体能与可燃物质发生迅速而聚类的反应。可燃物质包括含碳的有机物质，例如大多数可燃气体，可燃液体、油、润滑脂（greases），很多塑料和植物；金属粉末；及其它可氧化物质，例如肼（hydrazine）、氢（hydrogen）、 氢化物（hydrides）、硫（sulphur）或硫化合物，硅（silicon）和氨（ammonia）或氨化合物。 |
| 6  |  |   reducing_gases（还原性气体） | ppm  | 指化学反应中经常作为还原剂使用的气体。例如氢气（hydrogen）、一氧化碳(carbon monoxide)等。|
| 7  |   |  SO<sub>2</sub>(二氧化硫, Sulfur Dioxide) |  ppm | SO<sub>2</sub> 可被用作更大种类气态硫氧化物SO<sub>x</sub>（gaseous sulfur oxides）的指示物（ indicator）。 大气中发现其它气态硫，例如SO<sub>3</sub>的浓度应小于SO<sub>2</sub>。减少SO<sub>2</sub>的控制措施通常可以预期减少人们暴漏到所有SO<sub>x</sub>中的机会。对减少颗粒状硫污染物（例如细硫酸盐颗粒，fine sulfate particles）的形成同样重要。<br>SO<sub>2</sub>最主要来源于发电厂和其它工业设施的化石燃料燃烧；较小来源于从矿石中提取金属等工业过程，火山等自然资源，机车、轮船和其它车辆，及重型设备，其燃烧的燃料含硫量较高。<br>短期接触SO<sub>2</sub>会损害人体呼吸系统，是呼吸困难。哮喘患者、尤其儿童对SO<sub>2</sub>的这些影响尤其敏感。导致空气中SO<sub>2</sub>高浓度形成的排放也会导致其它氧化物（SO<sub>x</sub>）的形成。与大气中的其它化合物发生反应，形成小颗粒。这些颗粒导致了微粒物质污染（ particulate matter，PM）。小颗粒可以渗入人的肺部，如果达到一定量则会导致健康问题。自然中，高浓度的气态硫会破坏植被的树叶，降低其生长速度。|
| 8  | 颗粒物，微粒(particulate matter,PM)  | pm<sub>1</sub>,pm<sub>2.5</sub>, pm<sub>5</sub>,pm<sub>10</sub> | μg/m<sup>3</sup>  |  PM代表颗粒物质（也称之为颗粒污染，particle pollution），是空气中存在的固体颗粒和液滴的混合物。有些颗粒，例如灰尘粉末、煤烟等大到肉眼可见；另一些则很小，只能用电子显微镜观察。<br>颗粒污染包括：PM<sub>10</sub>可吸入颗粒物，直径一般在10微米（micrometers）及一下；PM<sub>2.5</sub>可吸入的细小微粒，直径一般在2.5微米一下。这些颗粒有许多大小和形状，可由数百种不同的化学物质组成。<br>颗粒污染有些是直接从源头排放，例如建筑工地、未铺设的道路、田地、烟囱或火灾等。大气中的大多数颗粒由二氧化硫和氧化物等化学物质的复杂反应形成，通常是发电厂、工业和汽车排放的污染物。<br>颗粒物包含微小的固体或液滴，因为非常小，足可以被吸入并导致严重的健康问题。一些小于10微米的颗粒可以进入人的肺部，一些甚至可能进入到人的血液中。直径小于2.5微米的颗粒，也称为细颗粒（ fine particles，或者PM<sub>2.5</sub>），对健康构成最大的风险。PM<sub>2.5</sub>也是雾霾的主要起因。 |
| 9  | 热环境  | 温度（temperature）   |  C | 在强调温度的时空分布时，通常使用热状态（thermal regime）一词。温度在塑造水生态系统的结构和功能时起到基本作用。例如在物理（Physical）层面上， 影响水密度（Water density）、热分层（thermal stratification），氧和其它化学物质的溶解度（solubility ）；在化学（Chemical）层面上，影响养分循环速率、污染物转换速率；在生物（Biological）层面上，影响生物的生存、生长、繁殖、发展、行为、生境偏好和竞争。温度同样影响人们活动的热舒适度，以及某些事物发生的起因，例如在加热的排放物附近聚集的鱼群，不透水表面影响等。|
| 10  |   |  湿度（humidity） | 相对湿度（Relative Humidity, RH）  | RH是空气中湿度的量度，与潜在的饱和水平相比较（potential saturation level）。温暖的空气可以容纳更多的水分，当接近100%的湿度时，空气中的水分会凝结（露点）。RH是热舒适性的决定条件之一。  |
| 11  |   | 大气压（pressure）  |  hPa（Hectopascal Pressure Unit） |  百帕斯卡是帕斯卡的100倍，帕斯卡是国际单位制的压力单位。百帕斯卡是测量大气压力或气压的国际单位。1百帕斯卡等于100帕斯卡。 |
| 12  | 噪音  | octave_n_intensity  | dB（分贝）  | 声压级计算（Sound Pressure Level Calculation），每65秒报告一次周围的噪音水平（1分钟间隔，5秒采样）。从麦克风采样音频5秒，以dBm（毫瓦分贝）计算噪音水平。声压级的估计是基于傅里叶变换。通过傅里叶变换将麦克风采集到的数据转换成频率强度域。在频率强度域中，选取22hz ~ 22khz的频率计算给定倍频带（Octave_band用于控制倍频，默认为1/1倍频。octave_n_intensity，默认10个。）下的平均dBm。 <br> 噪音通常来源于交通工具、工厂机器设备、建筑施工和人们的社会和家庭活动等。噪音对人类的危害主要表现在听力的损伤、睡眠干扰、人体的生理和心理影响。当在100分贝左右噪音环境下工作会感到刺耳、难受、甚至引起暂时性耳聋。超过140分贝的噪音会引起眼球振动，视觉模糊，呼吸、脉搏和血压都会发生波动。甚至会使用、全身血管收缩，供血减少，说话能力了受到影响。|
| 13  | 光  | 光强度（light intensity）/可见光强度（visible light intensity）  | 照度：uW/cm<sup>2</sup>（辐照度（irradiance）单位，落在单位表面上的能量）； lux（光度单位，落在单位表面上的可见光）。  |  人工照明在为人类带来好处的同时，对环境也带来了负面的影响。例如光污染用来描述过度的夜间人工照明，尤其是在大型的城市聚集区。这对自然适应夜间生活的动植物和人类健康产生负面影响。同时，城市区域的高层建筑高度和密度也对城市室外和室内的太阳光照时长带来直接的影响。 |
| 14  |   | 红外光谱强度（ir_intensity）  | uW/cm<sup>2</sup>  |  / |
| 15 |   | 紫外线强度（uv_intensity）  | uW/cm<sup>2</sup>  | 臭氧层的损耗减少了大气吸收紫外线避免生物受到伤害的能力。过度暴露于紫外线下影响人类的健康，这包括皮肤癌等各类皮肤疾病，又如光化性角化病、 皮肤过早老化等；同时会增加某些白内障的可能性及眼睛损伤；也会抑制人体免疫系统的正常功能等。|
| 16  | 电磁场（EMFs ，Electric and magnetic fields）  | magnetic_field_x/y/z  | mG  | 除地球磁场外，电磁场由各类电子设备产生，是人类日常生活的一部分。目前没有证据证明其于任何疾病有关。  |
| 17  | 惯性测量装置（inertial measurement unit，IMU）  | 加速度（acceleration_x/y/z）  | mg  | /  |



> 主要参考 [EPA](https://www.epa.gov/)(U.S. Environmental Protection Agency)

`sensors.csv`文件包含了所有已发布数据（data文件）传感器信息。从给定链接中可以获取传感器详细说明。使用`pd.read_csv()`读取`sensors.csv`文件查看。
```python
AoT_sensors_fp=cfg['AoT']['AoT_sensors_fp']
AoT_nodes_df=pd.read_csv(AoT_sensors_fp,sep=",",header=0)
print(AoT_nodes_df)
```

`sensors.csv`文件包含的数据信息主要有：

* `ontology` - 传感器测量对象.
* `subsystem` - 包含传感器的子系统.
* `sensor` - 传感器名称.
* `parameter` - 传感器参数.
* `hrf_unit` - HRF值（转换传感器测量值后）物理单位.
* `hrf_minval` - 依据传感器说明，HRF最小值，用于过滤数值（异常值）；
* `hrf_maxval` - 依据传感器说明，HRF最大值，用于过滤数值（异常值）；
* `datasheet` - 传感器说明书的下载地址。


|ontology                                        |subsystem |sensor         |parameter              |hrf_unit   |hrf_minval|hrf_maxval|datasheet                                                                                |
|------------------------------------------------|----------|---------------|-----------------------|-----------|----------|----------|-----------------------------------------------------------------------------------------|
|/sensing/air_quality/gases/co                   |chemsense |co             |concentration          |ppm        |0         |1000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/co.pdf            |
|/sensing/air_quality/gases/h2s                  |chemsense |h2s            |concentration          |ppm        |0         |50        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/h2s.pdf           |
|/sensing/air_quality/gases/no2                  |chemsense |no2            |concentration          |ppm        |0         |20        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/no2.pdf           |
|/sensing/air_quality/gases/o3                   |chemsense |o3             |concentration          |ppm        |0         |20        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/o3.pdf            |
|/sensing/air_quality/gases/oxidizing_gases      |chemsense |oxidizing_gases|concentration          |ppm        |0         |100       |https://github.com/waggle-sensor/sensors/blob/master/sensors/chemsense                   |
|/sensing/air_quality/gases/reducing_gases       |chemsense |reducing_gases |concentration          |ppm        |0         |20        |https://github.com/waggle-sensor/sensors/blob/master/sensors/chemsense                   |
|/sensing/air_quality/gases/so2                  |chemsense |so2            |concentration          |ppm        |0         |20        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/so2.pdf           |
|/sensing/air_quality/particulates/particle_count|alphasense|opc_n2         |bins                   |counts     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/sensing/air_quality/particulates/pm_10         |alphasense|opc_n2         |pm10                   |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/sensing/air_quality/particulates/pm_2_5        |alphasense|opc_n2         |pm2_5                  |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/sensing/air_quality/particulates/pm_1          |alphasense|opc_n2         |pm1                    |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |point_3um_particle     |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |point_5um_particle     |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |1um_particle           |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |2_5um_particle         |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |5um_particle           |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/particle_count|plantower |pms7003        |10um_particle          |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_1          |plantower |pms7003        |pm1_cf                 |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_1          |plantower |pms7003        |pm1_atm                |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_2_5        |plantower |pms7003        |pm25_cf                |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_2_5        |plantower |pms7003        |pm25_atm               |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_10         |plantower |pms7003        |pm10_cf                |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/air_quality/particulates/pm_10         |plantower |pms7003        |pm10_atm               |μg/m^3     |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pms7003.pdf       |
|/sensing/meteorology/humidity                   |metsense  |hih4030        |humidity               |RH         |0         |100       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hih4030.pdf       |
|/sensing/meteorology/humidity                   |metsense  |htu21d         |humidity               |RH         |0         |100       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/htu21d.pdf        |
|/sensing/meteorology/pressure                   |metsense  |bmp180         |pressure               |hPa        |300       |1100      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/bmp180.pdf        |
|/sensing/meteorology/temperature                |metsense  |bmp180         |temperature            |C          |-40       |85        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/bmp180.pdf        |
|/sensing/meteorology/temperature                |metsense  |htu21d         |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/htu21d.pdf        |
|/sensing/meteorology/temperature                |metsense  |pr103j2        |temperature            |C          |-55       |80        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/pr103j2.pdf       |
|/sensing/meteorology/temperature                |metsense  |tmp112         |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tmp112.pdf        |
|/sensing/meteorology/temperature                |metsense  |tsys01         |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tsys01.pdf        |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_total_intensity |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_1_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_2_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_3_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_4_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_5_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_6_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_7_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_8_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_9_intensity     |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/audio/spl                     |audio     |microphone     |octave_10_intensity    |dB         |          |140       |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/audio_spl            |
|/sensing/physical/ir                            |lightsense|tsl260rd       |intensity              |uW/cm^2    |0         |132       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tsl260rd.pdf      |
|/sensing/physical/light                         |lightsense|apds_9006_020  |intensity              |lux        |0         |1000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/apd9006020.pdf    |
|/sensing/physical/light                         |lightsense|mlx75305       |intensity              |uW/cm^2    |0         |160       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/mlx75305c.pdf     |
|/sensing/physical/light                         |lightsense|tsl250rd       |intensity              |uW/cm^2    |0         |124       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tsl250rd.pdf      |
|/sensing/physical/magnetic_field                |lightsense|hmc5883l       |magnetic_field_x       |mG         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hmc5883l.pdf      |
|/sensing/physical/magnetic_field                |lightsense|hmc5883l       |magnetic_field_y       |mG         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hmc5883l.pdf      |
|/sensing/physical/magnetic_field                |lightsense|hmc5883l       |magnetic_field_z       |mG         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hmc5883l.pdf      |
|/sensing/physical/sound_level                   |metsense  |spv1840lr5h_b  |intensity              |dB         |0         |121       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/spv1840lr5h-b.pdf |
|/sensing/physical/uv                            |lightsense|ml8511         |intensity              |uW/cm^2    |0         |15        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/ml8511.pdf        |
|/sensing/physical/vibration                     |metsense  |mma8452q       |acceleration_x         |mg         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/mma8452q.pdf      |
|/sensing/physical/vibration                     |metsense  |mma8452q       |acceleration_y         |mg         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/mma8452q.pdf      |
|/sensing/physical/vibration                     |metsense  |mma8452q       |acceleration_z         |mg         |-8000     |8000      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/mma8452q.pdf      |
|/system/environment/humidity                    |lightsense|hih6130        |humidity               |RH         |0         |100       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hih6130.pdf       |
|/system/environment/ir                          |chemsense |si1145         |ir_intensity           |uW/cm^2    |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/si1145uv.pdf      |
|/system/environment/light                       |chemsense |si1145         |visible_light_intensity|uW/cm^2    |0         |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/si1145uv.pdf      |
|/system/environment/temperature                 |lightsense|hih6130        |temperature            |C          |-25       |85        |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/hih6130.pdf       |
|/system/environment/humidity                    |wagman    |htu21d         |humidity               |RH         |0         |100       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/htu21d.pdf        |
|/system/environment/temperature                 |wagman    |htu21d         |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/htu21d.pdf        |
|/system/environment/temperature                 |wagman    |temperatures   |battery                |C          |-55       |125       |https://github.com/waggle-sensor/core/blob/master/scripts/status-service                 |
|/system/environment/temperature                 |wagman    |temperatures   |brainplate             |C          |-55       |125       |https://github.com/waggle-sensor/core/blob/master/scripts/status-service                 |
|/system/environment/temperature                 |wagman    |temperatures   |ep_heatsink            |C          |-55       |125       |https://github.com/waggle-sensor/core/blob/master/scripts/status-service                 |
|/system/environment/temperature                 |wagman    |temperatures   |nc_heatsink            |C          |-55       |125       |https://github.com/waggle-sensor/core/blob/master/scripts/status-service                 |
|/system/environment/temperature                 |wagman    |temperatures   |powersupply            |C          |-55       |125       |https://github.com/waggle-sensor/core/blob/master/scripts/status-service                 |
|/system/environment/temperature                 |lightsense|tmp421         |temperature            |C          |-55       |127       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tmp421.pdf        |
|/system/environment/uv                          |chemsense |si1145         |uv_intensity           |uW/cm^2    |          |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/si1145uv.pdf      |
|/system/other/flow_rate                         |alphasense|opc_n2         |sample_flow_rate       |           |          |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/system/other/pressure                          |chemsense |lps25h         |pressure               |hPa        |260       |1260      |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/lps25h.pdf        |
|/system/other/humidity                          |chemsense |sht25          |humidity               |RH         |0         |100       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/sht25.pdf         |
|/system/other/id                                |chemsense |chemsense      |id                     |id         |          |          |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/id                                |metsense  |metsense       |id                     |id         |          |          |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/id                                |alphasense|opc_n2         |fw                     |           |          |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/system/other/light                             |metsense  |tsl250rd       |intensity              |uW/cm^2    |0         |124       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/tsl250rd.pdf      |
|/system/other/temperature                       |chemsense |lps25h         |temperature            |C          |-30       |105       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/lps25h.pdf        |
|/system/other/sampling_period                   |alphasense|opc_n2         |sampling_period        |           |          |          |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/opcn2.pdf         |
|/system/other/temperature                       |chemsense |at0            |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/temperature                       |chemsense |at1            |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/temperature                       |chemsense |at2            |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/temperature                       |chemsense |at3            |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors                                                 |
|/system/other/temperature                       |chemsense |sht25          |temperature            |C          |-40       |125       |https://github.com/waggle-sensor/sensors/raw/master/sensors/datasheets/sht25.pdf         |
|/system/loadavg                                 |nc        |loadavg        |loadavg1               |loadavg    |0         |          |https://github.com/waggle-sensor/plugin_manager/tree/master/plugins/status.plugin        |
|    ...                        |        |      |             |   |       |          |      |

###### 2) 环境传感器布局

为读取AoT数据，并写入到本地数据库中，首先建立`database.py`文件，将读写PostgreSQL数据库。同时，包括读取.yml格式的配置文件。

`database.py`
```python
# -*- coding: utf-8 -*-
"""
Created on Thu Feb  3 20:10:26 2022

@author: Richie Bao-caDesign设计(cadesign.cn)
"""

def gpd2postSQL(gdf,table_name,**kwargs):  
    '''
    function - 将GeoDataFrame格式数据写入PostgreSQL数据库
    
    Paras:
        gdf - GeoDataFrame格式数据，含geometry字段（几何对象，点、线和面，数据值对应定义的坐标系统）
        table_name - 写入数据库中的表名
        **kwargs - 连接数据库相关信息，包括myusername（数据库的用户名），mypassword（用户密钥），mydatabase（数据库名）
    '''    
    from sqlalchemy import create_engine
    #The URI should start with postgresql:// instead of postgres://. SQLAlchemy used to accept both, but has removed support for the postgres name.
    engine=create_engine("postgresql://{myusername}:{mypassword}@localhost:5432/{mydatabase}".format(myusername=kwargs['myusername'],mypassword=kwargs['mypassword'],mydatabase=kwargs['mydatabase']))  
    gdf.to_postgis(table_name, con=engine, if_exists='replace', index=False,)  
    print("_"*50)
    print('The GeoDataFrame has been written to the PostgreSQL database.The table name is {}.'.format(table_name))

def postSQL2gpd(table_name,geom_col='geometry',**kwargs):    
    '''
    function - 读取PostgreSQL数据库中的表为GeoDataFrame格式数据
    
    Paras:
        table_name - 待读取数据库中的表名
        geom_col='geometry' - 几何对象，常规默认字段为'geometry'
        **kwargs - 连接数据库相关信息，包括myusername（数据库的用户名），mypassword（用户密钥），mydatabase（数据库名）
    '''
    from sqlalchemy import create_engine
    import geopandas as gpd   
    
    engine=create_engine("postgresql://{myusername}:{mypassword}@localhost:5432/{mydatabase}".format(myusername=kwargs['myusername'],mypassword=kwargs['mypassword'],mydatabase=kwargs['mydatabase']))  
    gdf=gpd.read_postgis(table_name, con=engine,geom_col=geom_col)
    print("_"*50)
    print('The data has been read from PostgreSQL database. The table name is {}.'.format(table_name))    
    return gdf 

def cfg_load_yaml(ymlf_fp):
    '''
    读取 yaml 格式的配置文件

    Parameters
    ----------
    ymlf_fp : string
        配置文件路径.

    Returns
    -------
    cfg : yaml-dict
        读取到python中的配置信息.
    '''
    import yaml
    with open (ymlf_fp,'r') as ymlfile:
        cfg=yaml.safe_load(ymlfile)   
    return cfg
```

对AoT数据预处理的代码均写在`AoTData_preprocessing.py`下。读取`nodes.csv`数据，并将其写入到数据库。`nodes`数据给出了传感器的布置位置，在读取`data`数据并根据需求处理后（例如提取不同测量内容，并进一步分析后），需要根据各自给出的`node_id`字段，合并数据定位分析结果的空间分布，用于空间分析。

为定位传感器的空间位置，读取叠加行政区域。

`AoTData_preprocessing.py`
```python
# -*- coding: utf-8 -*-
"""
Created on Fri Feb  4 11:00:11 2022

@author: Richie Bao-caDesign设计(cadesign.cn)
"""

def AoT_nodes2gdf(nodes_fn,epsg=4326):
    '''
    读取AoT_nodes数据，并写入数据库

    Parameters
    ----------
    nodes_fn : string
        AoT_nodes文件路径.
    epsg : int, optional
        坐标投影系统，epsg编号. The default is 4326.

    Returns
    -------
    AoT_nodes_gdf : GeoDataFrame
        AoT_nodes的GeoDataFrame格式.

    '''
    import pandas as pd
    import geopandas as gpd
    from shapely.geometry import Point
    
    AoT_nodes_df=pd.read_csv(AoT_nodes_fp,sep=",",header=0)
    AoT_nodes_df["geometry"]=AoT_nodes_df.apply(lambda row:Point(row.lon,row.lat),axis=1) #使用shapely库建立几何点数据
    AoT_nodes_gdf=gpd.GeoDataFrame(AoT_nodes_df,crs=4326)
    if epsg!=4326:
        AoT_nodes_gdf.to_crs(epsg,inplace=True)
        
    print("nodes columns:{}".format(AoT_nodes_gdf.columns))
    return AoT_nodes_gdf

if __name__=="__main__":
    import sys,os
    sys.path.append('..')  
    
    from database import postSQL2gpd,gpd2postSQL,cfg_load_yaml   
    import pickle
    parent_path=os.path.dirname(os.getcwd())

    cfg=cfg_load_yaml('./config.yml')  
    UN=cfg["postgreSQL"]["myusername"]
    PW=cfg["postgreSQL"]["mypassword"]
    DB=cfg["postgreSQL"]["mydatabase"] 
    GC='geometry'     

    AoT_nodes_fp=cfg['AoT']['AoT_nodes_fp']
    Chicago_epsg=cfg['Chicago_epsg']

    #A. AoT-nodes信息读取并写入数据库
    AoT_nodes_gdf=AoT_nodes2gdf(AoT_nodes_fp,Chicago_epsg)
    AoT_nodes_TN=cfg['table_name']['AoT_nodes_TN']    
    gpd2postSQL(AoT_nodes_gdf,table_name=AoT_nodes_TN,myusername=UN,mypassword=PW,mydatabase=DB) 
    AoT_nodes_gdf=postSQL2gpd(table_name=AoT_nodes_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)
    
    #B.读取行政区划数据，并写入数据库，用于定位AoT分布
    import geopandas as gpd
    Chicago_Community_Areas_fn=cfg['raw_data']['Chicago_Community_Areas_fn']
    Chicago_community_areas=gpd.read_file(Chicago_Community_Areas_fn)
    Chicago_community_areas_TN=cfg['table_name']['Chicago_community_areas_TN']
    gpd2postSQL(Chicago_community_areas.to_crs(Chicago_epsg),table_name=Chicago_community_areas_TN,myusername=UN,mypassword=PW,mydatabase=DB)
    Chicago_community_areas=postSQL2gpd(table_name=Chicago_community_areas_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)  
```

<a href=""><img src="./imgs/3_3_2_01.png" height="auto" width="auto" title="caDesign"></a>

AoT在芝加哥布局了126个测量点位，位于道路街口，临湖道路、芝加哥大学校园内、或者邻近较大公园的附近道路、及中心城区、高速等不同环境，基本涵盖了芝加哥城全城区域。（为详细查看AoT在地图上的分布，可以转换`nodes`数据为.kml数据后，在[Google Earth](https://earth.google.com/web/)下读入）

`nodes.csv`读取的节点元数据个字段解释如下（来源于`README.md`文件）：

* `node_id` - 节点ID；
* `project_id` - 节点管理项目ID；
* `vsn` - 节点的公共名称，并标识在传感器设备上；
* `address` - 节点安装的街道地址；
* `lat` - 维度；
* `lon` - 精度；
* `description` - 对节点传感器构建和配置更详细的描述；
* `start_timestamp` - 节点安装的开始时间戳；
* `end_timestamp` - 节点安装结束的时间戳。

根据`lat`和`lon`建立GeoDataFrame的`geometry`几何对象。`node_id`用于数据合并关联字段。

###### 3) 分类数据

气体类、颗粒物、热环境、噪音、光等传感器测量的数据均混合写在`data`文件下。需要将数据测量内容分离出来单独保存，具体测量内容包含于`data`数据的`parameter`字段。编写`total_sample_length_csv()`方法，计算样本长度，并提取`parameter`字段pickle写入到单独文件下，方便后续数据分类提取时调用。

`AoTData_preprocessing.py`
```python
def total_sample_length_csv(csv_fp,chunksize,category=None,save_fp=None):
    '''
    读取.csv样本数据，计算样本总长度（行数）;并给定分类字段，提取分类名并保存

    Parameters
    ----------
    csv_fp : string
        .csv文件路径.
    chunksize : int
        数据块大小（单独一次读取的行数）.
    category : string(column name), optional
        分类字段. The default is None.
    save_fp : string, optional
        分类名保存路径. The default is None.

    Returns
    -------
    category_set : set
        分类名集合.

    '''
    from tqdm.auto import tqdm
    import pandas as pd
    import pickle
    
    count=0
    set_list=[]
    for chunk in tqdm(pd.read_csv(csv_fp,chunksize=chunksize)):
        count+= 1 #样本分组数
        last_len=len(chunk)  #最后一组的样本数量
        if category:
            set_list.append(set(chunk[category]))
        # if count==3:break
            
    data_length=(count*chunksize+last_len-chunksize) #数据行（样本）总长度
    print("数据行（样本）总长度={}".format(data_length)) 
    if category:
        category_set=set().union(*set_list)
        if save_fp:
            with open(save_fp,'wb') as f:
                pickle.dump(category_set,f)            
        return category_set

if __name__=="__main__":
    #C.AoT-data数据样本长度计算，并提取data:parameter传感器测量分类字段   
    AoT_data_fp=cfg['AoT']['AoT_data_fp']
    category_set_fp=cfg['processed_data']['category_set_fp']
    category_set=total_sample_length_csv(AoT_data_fp,chunksize=10**6,category='parameter',save_fp=category_set_fp) #数据行（样本）总长度=573074785
    with open(category_set_fp,'rb') as f:
        category_set=pickle.load(f)             
```

`data:parameter`计算结果具体如下：

    {'10um_particle',
    '1um_particle',
    '2_5um_particle',
    '5um_particle',
    'acceleration_x',
    'acceleration_y',
    'acceleration_z',
    'alphasense',
    'b',
    'bins',
    'commit',
    'concentration',
    'coresense',
    'cs',
    'current',
    'device',
    'ep',
    'free',
    'fw',
    'g',
    'humidity',
    'id',
    'idletime',
    'intensity',
    'ir_intensity',
    'load_1',
    'load_10',
    'load_5',
    'magnetic_field_x',
    'magnetic_field_y',
    'magnetic_field_z',
    'major',
    'minor',
    'modem',
    'nc',
    'octave_10_intensity',
    'octave_1_intensity',
    'octave_2_intensity',
    'octave_3_intensity',
    'octave_4_intensity',
    'octave_5_intensity',
    'octave_6_intensity',
    'octave_7_intensity',
    'octave_8_intensity',
    'octave_9_intensity',
    'octave_total_intensity',
    'other',
    'patch',
    'pm1',
    'pm10',
    'pm10_atm',
    'pm10_cf1',
    'pm1_atm',
    'pm1_cf1',
    'pm25_atm',
    'pm25_cf1',
    'pm2_5',
    'point_3um_particle',
    'point_5um_particle',
    'pressure',
    'r',
    'rx',
    'sample_flow_rate',
    'sampling_period',
    'state',
    'substate',
    'temperature',
    'total',
    'tx',
    'uptime',
    'used',
    'uv_intensity',
    'visible_light_intensity',
    'wagman'}

因为`data`数据量有39.5GB，样本总长度为573,074,785条。根据`data:parameter`字段分类提取数据时，可能造成内存溢出，因此分批读取与写入。另外，在处理`data`数据时，为提高计算效率，缩短计算时长，有如下考虑：

1. 可以根据后续分析内容提前规划所要提取的数据字段，舍弃不需要的字段；
2. 提取的分类数据保存格式可以是pickle方式保存的DataFrame数据格式，也可以用geopandas保存为GPKG数据格式。需要注意，geopandas因为要处理几何空间对象，因此pickle读写效率要远远高于geopandas读写效率，具体选择哪种存储方式，可以根据具体情况调整。同时，因为单个文件较大的数据量，写入数据库时可能会出现错误，及较长的读写时间，因此并没有将数据写入数据库；(实验中，两种格式均有保存)
3. 使用多线程处理，加快计算速度。多线程计算时，有个别分类字段可能会超出内存大小中断程序，对这些分类字段可单独进行计算；
4. pd.read_csv(data_fn,chunksize=chunksize)读取`data`时，使用`chunksize`参数分批读取数据，避免内存溢出。

`data(data.csv.gz)`数据文件包含的字段信息包括：

* `timestamp` - 测量了完成时的UTC（Coordinated Universal Time）时间戳；
* `node_id` - 用于测量的节点ID；
* `subsystem` - 包含传感器节点的子系统；
* `sensor` - 用于测量的传感器；
* `parameter` - 测量的传感器参数；
* `value_raw` - 来自传感器的原始测量值；
* `value_hrf` - 从传感器转换的“可读”值，即标准测量单位。

`AoTData_preprocessing_pool.py`
```python
# -*- coding: utf-8 -*-
"""
Created on Fri Feb  4 19:00:35 2022

@author: Richie Bao-caDesign设计(cadesign.cn)
"""

def AoT_data_category_pool(category,args):
    '''
    读取AoT-data数据，并存储为.gpkg或者.pkl

    Parameters
    ----------
    category : string
        分类名.
    args : list
        变量列表.

    Returns
    -------
    category : string
        分类名。可以不定义返回值，该返回值即为输入值.

    '''
    import pandas as pd
    import geopandas as gpd
    import os
    import pickle
    
    data_fn,chunksize,category_column,save_path,AoT_nodes=args    
    category_fn_dict={}
    count=0
    temp=[]
    for chunk in pd.read_csv(data_fn,chunksize=chunksize):
        temp.append(chunk[chunk[category_column]==category])            
        count+= 1
        # if count==3:break
    category_df=pd.concat(temp)    
    # print("+"*50)
    # print(category_df)
    if category_df.empty is False:
        if AoT_nodes is not None:
            category_df=pd.merge(category_df,AoT_nodes,on="node_id")
            category_gdf=gpd.GeoDataFrame(category_df,crs=AoT_nodes.crs)
            category_fn=os.path.join(save_path,"{}.gpkg".format(category))
            category_gdf.to_file(category_fn,driver="GPKG")    
        else:
            category_fn=os.path.join(save_path,"{}.pkl".format(category))
            category_df.to_pickle(category_fn)
    else:
        return category

if __name__=="__main__":
    #下述代码测试多线程调用的子程序
    import sys,os
    sys.path.append('..')  
    
    from database import postSQL2gpd,gpd2postSQL,cfg_load_yaml   
    import pickle
    parent_path=os.path.dirname(os.getcwd())

    cfg=cfg_load_yaml('./config.yml')  
    UN=cfg["postgreSQL"]["myusername"]
    PW=cfg["postgreSQL"]["mypassword"]
    DB=cfg["postgreSQL"]["mydatabase"] 
    GC='geometry'     
    
    AoT_data_fp=cfg['AoT']['AoT_data_fp']
    category_set_fp=cfg['processed_data']['category_set_fp']
    with open(category_set_fp,'rb') as f:
         category_set=pickle.load(f) 
        
    AoT_data_category_save_fp=cfg['processed_data']['AoT_data_category_save_fp']  
    AoT_nodes_TN=cfg['table_name']['AoT_nodes_TN']     
    AoT_nodes_gdf=postSQL2gpd(table_name=AoT_nodes_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)
    for category in list(category_set)[:3]:
         _=AoT_data_category_pool(category,[AoT_data_fp,10**6,'parameter',AoT_data_category_save_fp,AoT_nodes_gdf])
```

`AoTData_preprocessing.py`
```python
def AoT_data_sort(data_fn,category_set,category_column,save_path,chunksize,AoT_nodes=None):
    '''
    多线程。读取AoT-data数据，并存储为.gpkg或者.pkl

    Parameters
    ----------
    data_fn : string
        AoT_data数据，传感器测量数据.
    category_set : list(string)
        data:parameter传感器测量分类字段列表.
    category_column : string
        判断分类的列表，即AoT-data的parameter字段.
    save_path : string
        文件保存的根目录.
    chunksize : int.
        分批读取数据一次读取的文件量（样本行）.
    AoT_nodes : GeoDataFrame, optional
        AoT-nodes节点信息数据，包含节点分布几何点（geometry）。如果给定该参数则保存为GPKG，否则保存为.pkl(pickle保存). The default is None.

    Returns
    -------
    category_none : list(string)
        已经保存的分类数据名列表.
    '''
    from tqdm.auto import tqdm
    from multiprocessing import Pool
    from AoTData_preprocessing_pool import AoT_data_category_pool
    from functools import partial
    
    args=partial(AoT_data_category_pool, args=[data_fn,chunksize,category_column,save_path,AoT_nodes])
    with Pool(8) as p:
        category_none=p.map(args, tqdm(list(category_set))) #[:3]
        
    category_fn_dict={category:os.path.join(save_path,"{}.pkl".format(category)) for category in category_set}
    category_fn_dict_fn= os.path.join(save_path,"category_fn_dict.pkl")  
    with open(category_fn_dict_fn,'wb') as f:
        pickle.dump(category_fn_dict,f)
    return category_none    

def AoT_data_category_single(data_fn,category,category_column,save_path,AoT_nodes=None,chunksize=10**6):
    '''
    读取AoT-data数据，提取单个分类，并存储为.gpkg或者.pkl

    Parameters
    ----------
    data_fn : string
        AoT_data数据，传感器测量数据.
    category : string
        提取单个分类数据的分类名.
    category_column : string
        判断分类的列表，即AoT-data的parameter字段.
    save_path : string
        文件保存的根目录.
    AoT_nodes : GeoDataFrame,optional
        AoT-nodes节点信息数据，包含节点分布几何点（geometry）。如果给定该参数则保存为GPKG，否则保存为.pkl(pickle保存). The default is None.
    chunksize : int, optional
        分批读取数据一次读取的文件量（样本行）. The default is 10**6.

    Returns
    -------
    category : string
        分类名。可以不定义返回值，该返回值即为输入值.

    '''
    import pandas as pd
    import geopandas as gpd
    import os
    import pickle    
    
    count=0
    for chunk in pd.read_csv(data_fn,chunksize=chunksize):
        category_chunk_df=chunk[chunk[category_column]==category]          
        count+= 1  
        
        if category_chunk_df.empty is False:
            if AoT_nodes is not None:
                category_chunk_df=pd.merge(category_chunk_df,AoT_nodes,on="node_id")
                category_chunky_gdf=gpd.GeoDataFrame(category_chunk_df,crs=AoT_nodes.crs)
                category_chunk_fn=os.path.join(save_path,"{}_{}.gpkg".format(category,count))
                category_chunky_gdf.to_file(category_chunk_fn,driver="GPKG")    
            else:
                category_chunk_fn=os.path.join(save_path,"{}_{}.pkl".format(category,count))
                category_chunk_df.to_pickle(category_chunk_fn)
        else:
            return category 

if __name__=="__main__":
    #D.按data:parameter传感器测量分类字段，分类提取数据用pickle保存，或者用geopandas保存为GPKG格式地理数据。根据电脑算力确定
    AoT_data_category_save_fp=cfg['processed_data']['AoT_data_category_save_fp'] 
    category_none=AoT_data_sort(AoT_data_fp,category_set,'parameter',AoT_data_category_save_fp,chunksize=10**6,AoT_nodes=AoT_nodes_gdf) 
    #如果内存溢出，部分传感器分类数据不能写入（如temperature，shape (6, 169342609)），可以单独读取写入。为避免重新计算已计算分类，由下行代码提取未写入分类进行单独计算，或者手工配置
    from glob import glob
    from pathlib import Path    
    category_hold=category_set-set([Path(fn).stem for fn in glob(os.path.join(AoT_data_category_save_fp,"*.gpkg"))])
    print(category_hold) #结果为{'temperature'}    
    _=AoT_data_category_single(AoT_data_fp,'temperature','parameter',AoT_data_category_save_fp,AoT_nodes_gdf,chunksize=10**8) #手工配置为'temperature'
```

###### 4) 分析用潜在城市空间数据准备

AoT数据分析涉及到自身时空数据分析，包括单独节点的时间变化值和多个节点的时空变化值；及传感器测量值与城市空间环境相关因素的关系分析，例如建筑高度、道路、交通、城市用地，植被等。在实验过程中，无法预测相关因素关系情况下，会尝试多种可能性，这可能包括OSM提供的点标签（实际计算后发现提取的用地类型信息很少，及标签分类繁复，不易提取针对此次实验的相关信息）；或者节点位置的全景图语义分割对象百分比的关系等。

* 建筑高度数据

`Chicago data Portal`提供的`BUilding Footprints(current)`数据可以导出为多种格式类型，包括KML、KMX、Shapefile、GeoJSON等地理格式数据，以及CSV、CSV for Excel、JSON、RDF、RSS、TSV for Excel及XML等非地理格式数据。这里下载的数据格式为GeoJSON地理格式数据，可以用geopandas直接读取为GeoDataFrame数据格式。为方便调用，并配置投影和转换字段为字符串的列为数值类型（float, int等）定义函数`json2gdf()`。

`database.py`
```python
def json2gdf(json_fn,numeric_columns=None,epsg=None):
    '''
    读取.geojson(json)文件为GeoDataFrame格式文件，选择配置投影

    Parameters
    ----------
    json_fn : string
        文件路径.
    epsg : int, optional
        坐标投影系统，epsg编号. The default is None.

    Returns
    -------
    gdf : GeoDataFrmae
        转换后的GeoDataFrame格式文件.

    '''
    import geopandas as gpd
    
    gdf=gpd.read_file(json_fn)
    if epsg:
        gdf.to_crs(epsg,inplace=True)   
    print("fields_{}".format(gdf.columns))    
    if numeric_columns:
        gdf=gdf.astype(numeric_columns)

    return gdf

if __name__=="__main__":   
    #A.建筑轮廓（含层高）写入数据库
    Building_Footprints_fn=cfg['raw_data']['Building_Footprints_fn']    
    Building_Footprints=json2gdf(Building_Footprints_fn,numeric_columns={'no_stories':'int','stories':'int'},epsg=Chicago_epsg)
    
    Building_Footprints_TN=cfg['table_name']['Building_Footprints_TN']    
    BF_columns_selection=['no_stories','stories','geometry']
    gpd2postSQL(Building_Footprints[BF_columns_selection].dropna(),table_name=Building_Footprints_TN,myusername=UN,mypassword=PW,mydatabase=DB) 
    Building_Footprints=postSQL2gpd(table_name=Building_Footprints_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)   
```

<a href=""><img src="./imgs/3_3_2_02_s.jpg" height="auto" width="auto" title="caDesign"></a>

较高的建筑基本分布于临湖的中心城区。其余建筑多为住宅，混合低矮建筑的商业区。

* 道路中心线

下载的道路中心线数据格式为GeoJSON，可以直接用上述定义的`json2gdf()`函数读取数据并写入数据库。

`database.py`
```python
if __name__=="__main__":    
    #B.道路中心线 
    street_center_lines_fn=cfg['raw_data']['Street_Center_Lines_fn']
    street_center_lines=json2gdf(street_center_lines_fn,epsg=Chicago_epsg)
    street_center_lines_TN=cfg['table_name']['street_center_lines_TN']
    gpd2postSQL(street_center_lines,table_name=street_center_lines_TN,myusername=UN,mypassword=PW,mydatabase=DB) 
    street_center_lines=postSQL2gpd(table_name=street_center_lines_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)        
```

<a href=""><img src="./imgs/3_3_2_03_s.jpg" height="auto" width="auto" title="caDesign"></a>

下载的[Street Centerline Attributes and Lookup Tables](https://data.cityofchicago.org/Transportation/Street-Center-Lines/6imu-meau)文件描述了道路中心线字段，其中`STREET_TYPE`字段为道路分类，摘录如下：

| CODE| DESCRIPTION     |
|-----------|-----------|
| AVE| AVENUE           |
| BLVD| BOULEVARD       |
| CRES| CRESCENT COURT  |
| CT |COURT             |
| DR |DRIVE             |
| ER| ENTRANCE RAMP     |
| EXPY| EXPRESSWAY      |
| HWY| HIGHWAY          |
| LN |LANE              |
| PKWY| PARK WAY        |
| PL |PLACE             |
| ROW |ROW              |
| SQ| SQUARE            |
| SR |SERVICE ROAD      |
| ST| STREET            |
| TER |TERRACE          |
| TOLL| TOLL WAY        |
| VIA |WAY              |
| WAY| EXIT RAMP        |

* 土地利用

土地利用（Land Use Inventory）从[CMAP(Chicago Metropolitan Agency for Planning) Data Hub](https://datahub.cmap.illinois.gov/group/land-use-inventories) 下载，数据文件时间为2015年（通常每5年一更新）。下载地址也提供了'Land Use Inventory Metadata (2015)'PDF说明文件，可以对照`LANDUSE`字段提供的代码查看土地利用。该部分的映射也写在`config.yml`配置文件中。

读取研究区域（芝加哥城边界数据）用前文定义的`shp2gdf()`函数。对于土地利用数据的读取和裁切，重新定义`shp2gdf_updated()`函数，使用`gpd.clip()`方法裁切。

`database.py`
```python
def shp2gdf(fn,epsg=None,boundary=None,encoding='utf-8'):    
    '''
    function - 转换.shp地理信息数据为GeoDataFrame(geopandas)数据格式，可以配置投影
    
    Paras:
        fn - .shp文件路径
        epsg - 配置投影，默认为None
        boundary - 配置裁切边界，默认为None
        encoding - 配置编码，默认为'utf-8'
    '''
    import geopandas as gpd
    
    shp_gdf=gpd.read_file(fn,encoding=encoding)
    print('original data info:{}'.format(shp_gdf.shape))
    shp_gdf.dropna(how='all',axis=1,inplace=True)
    print('dropna-how=all,result:{}'.format(shp_gdf.shape))
    shp_gdf.dropna(inplace=True)
    print('dropna-several rows,result:{}'.format(shp_gdf.shape))
    if epsg is not None:
        shp_gdf_proj=shp_gdf.to_crs(epsg=epsg)
        print(shp_gdf_proj.crs)
    if boundary:
        shp_gdf_proj['mask']=shp_gdf_proj.geometry.apply(lambda row:row.within(boundary))
        shp_gdf_proj.query('mask',inplace=True)        
    
    return shp_gdf_proj

def shp2gdf_updated(fn,boundary=None,encoding='utf-8'):    
    '''
    function - 转换.shp地理信息数据为GeoDataFrame(geopandas)数据格式，配置投影为给定边界的crs，并应用gpd.clip()方法裁切
    
    Paras:
        fn - .shp文件路径
        boundary - 配置裁切边界，默认为None
        encoding - 配置编码，默认为'utf-8'
    '''
    import geopandas as gpd
    from tqdm import tqdm
    tqdm.pandas()  
    
    shp_gdf=gpd.read_file(fn,encoding=encoding)    
    if boundary is not None:        
        shp_gdf['mask']=shp_gdf.geometry.progress_apply(lambda row:row.is_valid)
        shp_gdf=shp_gdf[shp_gdf['mask']==True]
        shp_clip_gdf=gpd.clip(shp_gdf.to_crs(boundary.crs),boundary)    
        return shp_clip_gdf
    else:
        return shp_gdf

if __name__=="__main__":
    #C.土地利用
    #研究边界
    Chicago_boundary_fp=cfg['raw_data']['Chicago_boundary']
    Chicago_boundary_gdf=shp2gdf(Chicago_boundary_fp,epsg=Chicago_epsg)
    Chicago_boundary_TN=cfg['table_name']['Chicago_boundary_TN']
    gpd2postSQL(Chicago_boundary_gdf,table_name=Chicago_boundary_TN,myusername=UN,mypassword=PW,mydatabase=DB)    
    Chicago_boundary=postSQL2gpd(table_name=Chicago_boundary_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)
    
    #读取土地利用数据并裁切到研究区域
    landuse_fn=cfg['raw_data']['landuse_fn']
    landuse_gdf=shp2gdf_updated(landuse_fn,boundary=Chicago_boundary)
    landuse_mapping=cfg['landuse']['landuse_mapping']
    landuse_gdf['landuse_name']=landuse_gdf['LANDUSE'].map(landuse_mapping)

    landuse_TN=cfg['table_name']['landuse_TN']
    gpd2postSQL(landuse_gdf,table_name=landuse_TN,myusername=UN,mypassword=PW,mydatabase=DB)
    landuse_gdf=postSQL2gpd(table_name=landuse_TN,geom_col=GC,myusername=UN,mypassword=PW,mydatabase=DB)
```

<a href=""><img src="./imgs/3_3_2_04_s.jpg" height="auto" width="auto" title="caDesign"></a>

* 植被（高，中，低）

该部分数据是直接使用'点云数据处理'一章中使用[.las格式的激光雷达数据](https://www.arcgis.com/apps/webappviewer/index.html?id=44eb65c92c944f3e8b231eb1e2814f4d)提取的植被信息，包括高的树木（high vegetation），中等树木（medium vegetation）和低矮树木（low vegetation）。栅格的投影为`EPSG:6455 - NAD83(2011) / Illinois East (ftUS)`，需要统一为本次实验的投影`EPSG:32616 - WGS 84 / UTM zone 16N`。定义栅格数据重投影的函数`raster_reprojection()`转换投影坐标。

`database.py`
```python
def raster_reprojection(raster_fp,save_path,dst_crs):
    from rasterio.warp import calculate_default_transform, reproject, Resampling
    import rasterio as rio
    '''
    function - 转换栅格投影
    
    Paras:
        raster_fp - 待转换投影的栅格
        dst_crs - 目标投影
        save_path - 保存路径
    '''
    with rio.open(raster_fp) as src:
        transform, width, height = calculate_default_transform(src.crs, dst_crs, src.width, src.height, *src.bounds)
        kwargs = src.meta.copy()
        kwargs.update({
            'crs': dst_crs,
            'transform': transform,
            'width': width,
            'height': height,
            "compress":'lzw',
        })
        with rio.open(save_path, 'w', **kwargs) as dst:
            for i in range(1, src.count + 1):
                reproject(
                    source=rio.band(src, i),
                    destination=rio.band(dst, i),
                    src_transform=src.transform,
                    src_crs=src.crs,
                    dst_transform=transform,
                    dst_crs=dst_crs,
                    resampling=Resampling.nearest)      

def raster_reprojection_batch(srcs,dsts,epsg):
    '''
    批量转换栅格投影

    Parameters
    ----------
    srcs : string
        待转换投影的栅格路径名.
    dsts : string
        转换后存储栅格路径名.
    epsg : int
        坐标投影系统，epsg编号.

    Returns
    -------
    None.

    '''
    from tqdm import tqdm
    for i in tqdm(range(len(srcs))):
        raster_reprojection(srcs[i],dsts[i],epsg)  

if __name__=="__main__":
    #D. 树木（高，中，低）栅格数据重投影
    HighVegetation_fn=cfg['raw_data']['HighVegetation_fn']
    MediumVegetation_fn=cfg['raw_data']['MediumVegetation_fn']
    LowVegetation_fn=cfg['raw_data']['LowVegetation_fn']
    HighVegetation_reprojection_fn=cfg['processed_data']['HighVegetation_reprojection_fn']
    MediumVegetation_reprojection_fn=cfg['processed_data']['MediumVegetation_reprojection_fn']
    LowVegetation_reprojection_fn=cfg['processed_data']['LowVegetation_reprojection_fn']
    raster_reprojection_batch(srcs=[HighVegetation_fn,MediumVegetation_fn,LowVegetation_fn],dsts=[HighVegetation_reprojection_fn,MediumVegetation_reprojection_fn,LowVegetation_reprojection_fn],epsg=Chicago_epsg)   
```

<a href=""><img src="./imgs/3_3_2_05_s.jpg" height="auto" width="auto" title="caDesign"></a>

###### 5) 节点处全景图




##### B.2.2.2 QGIS建立地图


#### B.2.3 分析与结果

##### B.2.3.1

###### 1) 


### B.3 讨论与结论


#### B.参考文献


## C. 研究代码更新、发布与安装